[{"id":"18000974.c23df7","type":"tab","label":"Discovery","disabled":false,"info":""},{"id":"abe36278.d3a5e","type":"tab","label":"MQTT pubsub","disabled":false,"info":""},{"id":"9648297c.564688","type":"tab","label":"Databases","disabled":false,"info":""},{"id":"64c3c505.631b7c","type":"tab","label":"Website","disabled":false,"info":""},{"id":"3bd1ba7.f516946","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"d2b7de10.e07f8","type":"sqlitedb","z":"","db":"/home/pi/reference.db","mode":"RWC"},{"id":"667529e2.c47648","type":"sqlitedb","z":"","db":"/home/pi/data.db","mode":"RWC"},{"id":"8762f095.8167c","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":610,"y":2340,"wires":[]},{"id":"451485a4.eab36c","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"uibuilder","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"uibuilder.appcache","format":"text","x":360,"y":2340,"wires":[["8762f095.8167c"],["788e773c.8fb308"]]},{"id":"c9c6bfbf.46ff5","type":"link in","z":"64c3c505.631b7c","name":"IN uibuilder","links":[],"x":155,"y":2340,"wires":[["451485a4.eab36c"]]},{"id":"788e773c.8fb308","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":590,"y":2400,"wires":[]},{"id":"3a64a7b8.378fe8","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"deviceoverview","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.html","format":"text","x":800,"y":1320,"wires":[[],["ae041155.93082"]]},{"id":"b3315e46.18a65","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"devicesettings","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.js","format":"javascript","x":800,"y":1800,"wires":[["c9a7f8c2.6a75b8","49773ac0.0bd974"],["5f1eb621.58bee8"]]},{"id":"f771d26d.6d3f9","type":"link out","z":"64c3c505.631b7c","name":"OUT dashboard ctrl","links":["b34d632c.33631"],"x":955,"y":440,"wires":[]},{"id":"b34d632c.33631","type":"link in","z":"64c3c505.631b7c","name":"IN dashboard ctrl","links":["f771d26d.6d3f9"],"x":35,"y":60,"wires":[["c3a3b75c.dc7538"]]},{"id":"c3a3b75c.dc7538","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":60,"wires":[["23ba3661.406f5a"],["23ba3661.406f5a"],["5426df27.57377"]]},{"id":"5426df27.57377","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","x":270,"y":100,"wires":[]},{"id":"23ba3661.406f5a","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":60,"wires":[["8b07f23a.978cf"]]},{"id":"c44c4a6a.4b7f08","type":"comment","z":"64c3c505.631b7c","name":"DASHBOARD Autosending on page load","info":"ctrl messages from uibuilder node are analysed.\n\nIf page is (re)loading, the flow downwards is triggered.\n\nSee here:\nhttps://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki/How-to-send-data-when-a-client-connects-or-reloads-the-page","x":180,"y":20,"wires":[]},{"id":"a50781fb.ccf4a","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"dashboard","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.html","format":"text","x":790,"y":400,"wires":[["c00dd040.610c5"],["f771d26d.6d3f9"]]},{"id":"b04aa1bd.b7e8f","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":120,"wires":[["ca1c26f0.dc9a18"]]},{"id":"a7197f1c.4084c","type":"template","z":"64c3c505.631b7c","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout;","output":"str","x":580,"y":120,"wires":[["b04aa1bd.b7e8f"]]},{"id":"ca1c26f0.dc9a18","type":"function","z":"64c3c505.631b7c","name":"sort layout data","func":"msg.dashboardData = [];\n\nmsg.payload.forEach(function(item, index) {\n    var uiType = item.htmlid.split(\"-\")[0];\n    var measType = item.htmlid.split(\"-\")[1];\n    var deviceId = item.htmlid.split(\"-\")[2];\n    \n    msg.dashboardData.push({\n        htmlId : item.htmlid,\n        numberGroup : item.numbergroup,\n        numberItem : item.numberitem,\n        uiType : uiType,\n        measType : measType,\n        deviceId : deviceId\n    });\n\n});\n\nmsg.payload = msg.dashboardData;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":120,"wires":[["28b9abe8.1f6f84"]]},{"id":"25243793.9c5f58","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":180,"wires":[["74549113.8cd55"]]},{"id":"86f97d9d.c0737","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":360,"wires":[]},{"id":"28b9abe8.1f6f84","type":"function","z":"64c3c505.631b7c","name":"forEach send select showndatapoints where refId matching","func":"msg.dashboardData.forEach(function(e) {\n    if (e.htmlId.includes(\"chart\")) {\n        node.send({\n        \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + e.deviceId.toString() + \";\",\n        \"dashboardData\": msg.dashboardData,\n        \"dashboardGroups\": msg.dashboardGroups,\n        \"_socketId\": msg._socketId\n        });\n    }\n});\n//return msg;","outputs":1,"noerr":0,"x":460,"y":180,"wires":[["25243793.9c5f58"]]},{"id":"74549113.8cd55","type":"function","z":"64c3c505.631b7c","name":"include shownDataPoints in dashboardData","func":"//extract device id from sql query / topic\nvar deviceId = msg.topic.split(\"= \")[1].split(\";\")[0];\n\nmsg.dashboardData.forEach(function(e) {\n    if (e.htmlId.includes(\"chart\") && e.htmlId.includes(deviceId)) {\n        e.shownDataPoints = msg.payload[0].showndatapoints;\n        e.dispName = msg.payload[0].dispname;\n        e.deviceStatus = msg.payload[0].status;\n    }\n    else if(e.htmlId.includes(deviceId)) {\n        e.dispName = msg.payload[0].dispname;\n        e.deviceStatus = msg.payload[0].status;\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":180,"wires":[["ee9f70a8.3abc6"]]},{"id":"34b6f494.3bb2bc","type":"function","z":"64c3c505.631b7c","name":"forEach send select datapoints","func":"msg.dashboardData.forEach(function(e) {\n    var tempTopic = \"\";\n\n    if (e.htmlId.includes(\"chart\") && typeof e.shownDataPoints !== 'undefined') {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        \n        node.send({\n            \"topic\": tempTopic,\n            \"curItem\": e.htmlId,\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"_socketId\": msg._socketId\n        });\n    }\n    else if (e.htmlId.includes(\"val\")) {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        \n        \n        node.send({\n            \"topic\": tempTopic,\n            \"curItem\": e.htmlId,\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"_socketId\": msg._socketId\n        });\n    }\n});\n\n//return msg;","outputs":1,"noerr":0,"x":550,"y":300,"wires":[["57a89905.7bab38"]]},{"id":"57a89905.7bab38","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":300,"wires":[["fa5f1583.ef8818"]]},{"id":"fa5f1583.ef8818","type":"function","z":"64c3c505.631b7c","name":"include DataPoints in dashboardData","func":"var setLastItem = false;\n\nmsg.dashboardData.forEach(function(e, i) {\n    //check if incoming data is intended for this element\n    if (msg.curItem == e.htmlId) {\n        //reverse data from db and save in dashboardData object\n        e.DataPoints = msg.payload.reverse();\n        \n        \n        //check if this element is the last possible match\n        if (i == (msg.dashboardData.length -1)) {\n            setLastItem = true;\n        }\n    }\n});\n\nif (setLastItem) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\nmsg.topic = \"onLoadData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":300,"wires":[["43af503d.40513"]]},{"id":"43af503d.40513","type":"rbe","z":"64c3c505.631b7c","name":"","func":"rbei","gap":"","start":"","inout":"out","property":"payload","x":470,"y":360,"wires":[["86f97d9d.c0737","a50781fb.ccf4a"]]},{"id":"8b07f23a.978cf","type":"template","z":"64c3c505.631b7c","name":"select * from uigroups","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uigroups;","output":"str","x":580,"y":60,"wires":[["ce7f3719.9e0a88"]]},{"id":"ce7f3719.9e0a88","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":60,"wires":[["b860a17.bcc086"]]},{"id":"b860a17.bcc086","type":"function","z":"64c3c505.631b7c","name":"sort group data","func":"msg.dashboardGroups = [];\n\nmsg.payload.forEach(function(item, index) {\n    var itemList = [];\n    \n    item.items.split('').forEach(function(element) {\n        if (element == \"V\") itemList.push(\"value\")\n        else if (element == \"C\") itemList.push(\"chart\")\n    });\n    \n    \n    \n    msg.dashboardGroups.push({\n        htmlId : item.htmlid,\n        name: item.name,\n        items: itemList\n    });\n\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":60,"wires":[["a7197f1c.4084c"]]},{"id":"ae041155.93082","type":"link out","z":"64c3c505.631b7c","name":"OUT deviceoverview ctrl","links":["6cc9584a.fdaf08"],"x":955,"y":1360,"wires":[]},{"id":"6cc9584a.fdaf08","type":"link in","z":"64c3c505.631b7c","name":"IN deviceoverview ctrl","links":["ae041155.93082"],"x":35,"y":1240,"wires":[["f1ace5a5.683998"]]},{"id":"f1ace5a5.683998","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":1240,"wires":[["bd5ed093.448fa"],["bd5ed093.448fa"],[]]},{"id":"bd5ed093.448fa","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":1240,"wires":[["1e087322.c7683d"]]},{"id":"1e087322.c7683d","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1240,"wires":[["9a6764d8.cb08c8"]]},{"id":"eeec3363.a8305","type":"comment","z":"64c3c505.631b7c","name":"DEVICEOVERVIEW Autosending on page load","info":"","x":200,"y":1200,"wires":[]},{"id":"9a6764d8.cb08c8","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1240,"wires":[["c72101db.aba0b"]]},{"id":"c72101db.aba0b","type":"function","z":"64c3c505.631b7c","name":"sort overviewData","func":"msg.overviewData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.overviewData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\nmsg.topic = \"onLoadData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1240,"wires":[["3a64a7b8.378fe8","7477dc74.b20bd4"]]},{"id":"7477dc74.b20bd4","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":1300,"wires":[]},{"id":"942e030a.b8c34","type":"mqtt in","z":"18000974.c23df7","name":"","topic":"discovery/device","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":100,"y":80,"wires":[["c64d4c44.5d562"]]},{"id":"456ef5b1.4c15ac","type":"mqtt out","z":"18000974.c23df7","name":"","topic":"discovery/master","qos":"","retain":"","broker":"3bd1ba7.f516946","x":1050,"y":320,"wires":[]},{"id":"8f06f8bc.fdc668","type":"comment","z":"18000974.c23df7","name":"Discovery of new sensors template","info":"","x":160,"y":40,"wires":[]},{"id":"eef970a4.5af1c","type":"template","z":"18000974.c23df7","name":"select * from sensactref","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from sensactref;","output":"str","x":350,"y":200,"wires":[["b9723fea.150bc"]]},{"id":"a36c56a8.ec0b78","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"txpayload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":80,"wires":[["c5a81dd3.a991b"]]},{"id":"b9723fea.150bc","type":"sqlite","z":"18000974.c23df7","mydb":"d2b7de10.e07f8","sqlquery":"msg.topic","sql":"","name":"","x":600,"y":200,"wires":[["d5c158e.b5bdca8"]]},{"id":"a461bf7d.5b547","type":"function","z":"18000974.c23df7","name":"add to db with default vals","func":"msg.reference.forEach(function(element, index) {\n    if (element.name == msg.txpayload.name && !msg.ips.includes(msg.txpayload.ip)) {\n        msg.curRefId = msg.payload[0].refid+1;\n        \n        \n        msg.topic = \"insert into connections(IP, refid, category, types, curunit, curinterval, dispname, status, islogged, isnotifying, showndatapoints, isvisible) values('\" \n                    + msg.txpayload.ip + \"', \" + msg.curRefId + \", '\"+ element.category + \"', '\" + msg.txpayload.name + \"', '\" + element.defaultunits + \"', \" + element.defaultinterval + \", '\" + msg.txpayload.name\n                    + \"', 'connected', 1, 0, 10, 1);\";\n        return;\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":260,"wires":[["c1f02dbe.992e5"]]},{"id":"403d50bb.1d7fc","type":"debug","z":"18000974.c23df7","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":440,"wires":[]},{"id":"c64d4c44.5d562","type":"json","z":"18000974.c23df7","name":"","property":"payload","action":"","pretty":false,"x":270,"y":80,"wires":[["a36c56a8.ec0b78"]]},{"id":"d83c44bc.bffa48","type":"template","z":"18000974.c23df7","name":"select highest refid from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select refid from connections order by refid desc limit 1;","output":"str","x":310,"y":260,"wires":[["1381b81c.cdfe18"]]},{"id":"1381b81c.cdfe18","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":260,"wires":[["a461bf7d.5b547"]]},{"id":"d5c158e.b5bdca8","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"reference","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":200,"wires":[["d83c44bc.bffa48"]]},{"id":"c1f02dbe.992e5","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":320,"wires":[["bc542847.f3b9e8"]]},{"id":"bc542847.f3b9e8","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"curRefId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":810,"y":320,"wires":[["55e11370.3c2d4c","456ef5b1.4c15ac"]]},{"id":"55e11370.3c2d4c","type":"delay","z":"18000974.c23df7","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":580,"y":380,"wires":[["403d50bb.1d7fc","fa0385b3.254ec8"]]},{"id":"c5a81dd3.a991b","type":"template","z":"18000974.c23df7","name":"select IP from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select IP from connections;","output":"str","x":340,"y":140,"wires":[["afd2d78a.53e4d8"]]},{"id":"afd2d78a.53e4d8","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":140,"wires":[["4d0d9e65.0f587"]]},{"id":"4d0d9e65.0f587","type":"function","z":"18000974.c23df7","name":"reordering array","func":"var tempArray = []\n\nmsg.payload.forEach(function(element, index) {\n    if (!tempArray.includes(element.IP)) {\n        tempArray.push(element.IP);\n    }\n});\n\nmsg.ips = tempArray;\nreturn msg;","outputs":1,"noerr":0,"x":800,"y":140,"wires":[["eef970a4.5af1c"]]},{"id":"c00dd040.610c5","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1010,"y":360,"wires":[]},{"id":"4721308d.7440d","type":"comment","z":"64c3c505.631b7c","name":"Test page","info":"","x":180,"y":2280,"wires":[]},{"id":"fc9504f4.918af8","type":"comment","z":"64c3c505.631b7c","name":"DASHBOARD Send new data / Update","info":"","x":170,"y":440,"wires":[]},{"id":"30cc976f.f39cb8","type":"comment","z":"64c3c505.631b7c","name":"DEVICEOVERVIEW Send new data / Update","info":"","x":190,"y":1400,"wires":[]},{"id":"5f1eb621.58bee8","type":"link out","z":"64c3c505.631b7c","name":"OUT devicesettings ctrl","links":["42dd765a.dbe458"],"x":955,"y":1840,"wires":[]},{"id":"42dd765a.dbe458","type":"link in","z":"64c3c505.631b7c","name":"In devicesettings ctrl","links":["5f1eb621.58bee8"],"x":35,"y":1640,"wires":[["5ed20c86.c4b204"]]},{"id":"5ed20c86.c4b204","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":1640,"wires":[["474d24b7.3d53cc"],["474d24b7.3d53cc"],[]]},{"id":"474d24b7.3d53cc","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":1640,"wires":[["fc00718f.9f318"]]},{"id":"7c8d79bb.5eb0d8","type":"inject","z":"9648297c.564688","name":"","topic":"","payload":"100100200","payloadType":"num","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":100,"y":100,"wires":[["ea28cbb7.4935f8"]]},{"id":"7b74a248.af868c","type":"template","z":"9648297c.564688","name":"select humidity","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from H_{{payload}};","output":"str","x":360,"y":220,"wires":[["93d27080.9f612"]]},{"id":"93d27080.9f612","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":220,"wires":[["c665cbc3.114588"]]},{"id":"3c8ebf54.cc58d","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":890,"y":360,"wires":[]},{"id":"52365b6e.2c9dd4","type":"template","z":"9648297c.564688","name":"select temperature","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from T_{{payload}};","output":"str","x":370,"y":160,"wires":[["5939d67c.b09198"]]},{"id":"5939d67c.b09198","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":160,"wires":[["fab0f5f.a5c0808"]]},{"id":"fab0f5f.a5c0808","type":"csv","z":"9648297c.564688","name":"temp to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":790,"y":160,"wires":[["919867c0.4a29b8"]]},{"id":"c665cbc3.114588","type":"csv","z":"9648297c.564688","name":"hum to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":790,"y":220,"wires":[["a2255956.96c518"]]},{"id":"df076a40.8f9488","type":"file","z":"9648297c.564688","name":"","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/data.zip","appendNewline":false,"createDir":false,"overwriteFile":"true","encoding":"none","x":620,"y":280,"wires":[["3c8ebf54.cc58d"]]},{"id":"f3ad07d7.b0a9b8","type":"comment","z":"9648297c.564688","name":"CSV Test für Dateiausgabe","info":"momentaner Plan:\n1. Button in Settings, um db zu lesen und in csv mit standardnamen zu schreiben\n2. Wenn fertig, triggere Nachricht and uibuilder\n3. dort aktivieren des Downloadbuttons\n4. Download der Datei über Button","x":230,"y":40,"wires":[]},{"id":"23d5ca8d.5060a6","type":"zip","z":"9648297c.564688","name":"","mode":"compress","filename":"/home/pi/data.zip","outasstring":false,"x":330,"y":280,"wires":[["df076a40.8f9488"]]},{"id":"919867c0.4a29b8","type":"function","z":"9648297c.564688","name":"add to array","func":"msg.array = [];\n\nmsg.array.push({\n    filename: \"temperature.csv\",\n    payload: msg.payload\n});\n\nmsg.payload = msg.refId;\n\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":220,"wires":[["7b74a248.af868c"]]},{"id":"a2255956.96c518","type":"function","z":"9648297c.564688","name":"add to array","func":"msg.array.push({\n    filename: \"humidity.csv\",\n    payload: msg.payload\n});\n\nmsg.payload = msg.array;\n\nreturn msg;","outputs":1,"noerr":0,"x":170,"y":280,"wires":[["23d5ca8d.5060a6"]]},{"id":"ea28cbb7.4935f8","type":"function","z":"9648297c.564688","name":"backup id","func":"msg.refId = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":240,"y":100,"wires":[["52365b6e.2c9dd4"]]},{"id":"9fcfcba8.9450b8","type":"comment","z":"9648297c.564688","name":"Todo: trigger für Webseite, Download freizugeben","info":"","x":740,"y":80,"wires":[]},{"id":"fc00718f.9f318","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1640,"wires":[["278b38a9.c92b18"]]},{"id":"278b38a9.c92b18","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1640,"wires":[["10052f07.6f7611"]]},{"id":"10052f07.6f7611","type":"function","z":"64c3c505.631b7c","name":"sort settingsInputData, forEach send lastmsgtime","func":"var settingsInputData = [];\n\nmsg.payload.forEach(function(e,i) {\n    settingsInputData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status,\n        interval: e.curinterval,\n        units: e.curunit,\n        shownDataPoints: e.showndatapoints,\n        isNotifying: e.isnotifying,\n        lastReceivedVal: e.lastmsgtime,\n        manControl: e.mancontrol,\n        linkedTo: e.linkedto,\n        threshold: e.threshold,\n        linkRule: e.linkrule,\n        linkedMeas: e.linkedMeas\n    });\n    \n    node.send({\n        payload: e.lastmsgtime,\n        topic: e.refid,\n        settingsInputData: settingsInputData,\n        dataLength: msg.payload.length\n    });\n});\n","outputs":1,"noerr":0,"x":1130,"y":1640,"wires":[["11e2699d.d9c186"]]},{"id":"11e2699d.d9c186","type":"moment","z":"64c3c505.631b7c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"0","adjType":"hours","adjDir":"add","format":"fromNow","locale":"en_EN","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":800,"y":1700,"wires":[["afd7ece8.5fc"]]},{"id":"afd7ece8.5fc","type":"function","z":"64c3c505.631b7c","name":"attach formatted lastmsgtime","func":"\nmsg.settingsInputData.forEach(function(element, index) {\n    if (element.deviceId == msg.topic) {\n        element.lastReceivedVal = msg.payload;\n    }\n});\n\nmsg.topic = \"onLoadData\";\n\nif (msg.settingsInputData.length == msg.dataLength) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":1700,"wires":[["b3315e46.18a65","d3e09a75.2a42e8"]]},{"id":"d3e09a75.2a42e8","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":1700,"wires":[]},{"id":"c9a7f8c2.6a75b8","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1010,"y":1800,"wires":[]},{"id":"41ceab30.c70d04","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":80,"wires":[]},{"id":"42e16039.3417","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/temperature/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":160,"y":120,"wires":[["543994ae.d882ac"]]},{"id":"543994ae.d882ac","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/temperature/','');\nmsg.sign=\"T_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":120,"wires":[["41ceab30.c70d04","45bed4a7.8697bc"]]},{"id":"45bed4a7.8697bc","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/temperature","links":["26b05db9.863922"],"x":695,"y":120,"wires":[]},{"id":"c7ec51ad.0e469","type":"link in","z":"abe36278.d3a5e","name":"IN sensors/+ arranged","links":["a092a5a4.761be8"],"x":175,"y":1860,"wires":[["de3c78b8.ff3cd8"]]},{"id":"de3c78b8.ff3cd8","type":"change","z":"abe36278.d3a5e","name":"rearrange msg properties","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload[0].refid","tot":"msg"},{"t":"set","p":"clientinfo","pt":"msg","to":"payload[0]","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"txpayload","tot":"msg"},{"t":"delete","p":"txpayload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1860,"wires":[["80b35fe1.527cf"]]},{"id":"eb113de5.971f1","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1030,"y":2000,"wires":[]},{"id":"7755a085.7aa94","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/+ arranged","links":["c1aa9280.74ac1"],"x":995,"y":1960,"wires":[]},{"id":"4f6597a6.f32458","type":"comment","z":"abe36278.d3a5e","name":"generate unix time in ms","info":"","x":790,"y":1820,"wires":[]},{"id":"3fbf680f.dec6d8","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/temperature/100100200","payload":"111","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":80,"wires":[["543994ae.d882ac"]]},{"id":"80b35fe1.527cf","type":"template","z":"abe36278.d3a5e","name":"sign adding","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{sign}}{{topic}}","output":"str","x":570,"y":1860,"wires":[["60b24bf.8e2edb4"]]},{"id":"d9f24ace.2252b8","type":"moment","z":"abe36278.d3a5e","name":"","topic":"","input":"timeunix","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"2","adjType":"hours","adjDir":"add","format":"","locale":"de_DE","output":"timehr","outputType":"msg","outTz":"Europe/Berlin","x":780,"y":1960,"wires":[["7755a085.7aa94","eb113de5.971f1"]]},{"id":"60b24bf.8e2edb4","type":"moment","z":"abe36278.d3a5e","name":"","topic":"","input":"","inputType":"date","inTz":"Europe/Berlin","adjAmount":0,"adjType":"days","adjDir":"add","format":"unix","locale":"de_DE","output":"timeunix","outputType":"msg","outTz":"Europe/Berlin","x":780,"y":1860,"wires":[["5ed27902.f81e98"]]},{"id":"5ed27902.f81e98","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"change","p":"timeunix","pt":"msg","from":"uni","fromt":"str","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":1960,"wires":[["d9f24ace.2252b8"]]},{"id":"167e6a9e.37b845","type":"comment","z":"abe36278.d3a5e","name":"generate human readable time","info":"","x":810,"y":1920,"wires":[]},{"id":"7fffea6f.27bb54","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":200,"wires":[]},{"id":"3cdc04ab.7e84fc","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/humidity/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":240,"wires":[["6f46b459.5baf4c"]]},{"id":"6f46b459.5baf4c","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/humidity/','');\nmsg.sign=\"H_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":240,"wires":[["7fffea6f.27bb54","dbcd8d10.d25ad"]]},{"id":"dbcd8d10.d25ad","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/humidity","links":["26b05db9.863922"],"x":695,"y":240,"wires":[]},{"id":"7f4b367.f7abfc8","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/humidity/100100201","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":200,"wires":[["6f46b459.5baf4c"]]},{"id":"8b8b58af.d88628","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":320,"wires":[]},{"id":"35f32b73.e31a14","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/pressure/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":360,"wires":[["ecdd7ca5.5dc31"]]},{"id":"ecdd7ca5.5dc31","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/pressure/','');\nmsg.sign=\"P_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":360,"wires":[["8b8b58af.d88628","969a1c9f.d1b5a"]]},{"id":"969a1c9f.d1b5a","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/pressure","links":["26b05db9.863922"],"x":695,"y":360,"wires":[]},{"id":"7e5c6608.b819f8","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/pressure/100100202","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":320,"wires":[["ecdd7ca5.5dc31"]]},{"id":"ecee2408.636798","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":440,"wires":[]},{"id":"c3d906a3.124278","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/motion/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":480,"wires":[["6936f28c.9a581c"]]},{"id":"6936f28c.9a581c","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/motion/','');\nmsg.sign=\"M_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":480,"wires":[["ecee2408.636798","6c29658e.21602c"]]},{"id":"6c29658e.21602c","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/motion","links":["26b05db9.863922"],"x":695,"y":480,"wires":[]},{"id":"9f249f34.d6f0a","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/motion/100100203","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":440,"wires":[["6936f28c.9a581c"]]},{"id":"a5ab58ad.a80c08","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":560,"wires":[]},{"id":"b647dd19.d9c7f","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/button/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":600,"wires":[["3976f055.fb818"]]},{"id":"3976f055.fb818","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/button/','');\nmsg.sign=\"B_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":600,"wires":[["a5ab58ad.a80c08","44c9b998.acdcd8"]]},{"id":"44c9b998.acdcd8","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/button","links":["26b05db9.863922"],"x":695,"y":600,"wires":[]},{"id":"50b16c5a.cb8534","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/button/100100204","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":560,"wires":[["3976f055.fb818"]]},{"id":"9b3f831e.f37a7","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":680,"wires":[]},{"id":"dd55d42d.d96738","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/luminous/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":720,"wires":[["f308093.a6b8bf8"]]},{"id":"f308093.a6b8bf8","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/luminous/','');\nmsg.sign=\"L_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":720,"wires":[["9b3f831e.f37a7","c3f6e423.63bc68"]]},{"id":"c3f6e423.63bc68","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/luminous","links":["26b05db9.863922"],"x":695,"y":720,"wires":[]},{"id":"355b0bf4.04b714","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/luminous/100100205","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":680,"wires":[["f308093.a6b8bf8"]]},{"id":"226b07aa.6abb38","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":800,"wires":[]},{"id":"b71a1cd0.9f3eb","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/distance/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":840,"wires":[["d8ece886.86a2d8"]]},{"id":"d8ece886.86a2d8","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/distance/','');\nmsg.sign=\"D_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":840,"wires":[["226b07aa.6abb38","85fe13d4.8ba28"]]},{"id":"85fe13d4.8ba28","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/distance","links":["26b05db9.863922"],"x":695,"y":840,"wires":[]},{"id":"2fc7ec0.da5a014","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/distanz/100100206","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":800,"wires":[["d8ece886.86a2d8"]]},{"id":"d03c60ae.ac602","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":920,"wires":[]},{"id":"488c0f35.5064d","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/CO2/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":960,"wires":[["83c8e037.6dbee"]]},{"id":"83c8e037.6dbee","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/CO2/','');\nmsg.sign=\"C_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":960,"wires":[["d03c60ae.ac602","58100d27.50ff34"]]},{"id":"58100d27.50ff34","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/CO2","links":["26b05db9.863922"],"x":695,"y":960,"wires":[]},{"id":"1f0bbf8a.8773","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/CO2/100100207","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":920,"wires":[["83c8e037.6dbee"]]},{"id":"ef441750.cfc8c8","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1040,"wires":[]},{"id":"c8d6da71.693e88","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/VOC/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1080,"wires":[["d7c67fe0.d17bf"]]},{"id":"d7c67fe0.d17bf","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/VOC/','');\nmsg.sign=\"V_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1080,"wires":[["ef441750.cfc8c8","b7c84551.fa16a8"]]},{"id":"b7c84551.fa16a8","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/VOC","links":["26b05db9.863922"],"x":695,"y":1080,"wires":[]},{"id":"26e2aa8e.b25d76","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/VOC/100100208","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1040,"wires":[["d7c67fe0.d17bf"]]},{"id":"3c182d5b.28fc02","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1160,"wires":[]},{"id":"242acc7e.7c62e4","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/gyro/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1200,"wires":[["d25eb595.065288"]]},{"id":"d25eb595.065288","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/gyro/','');\nmsg.sign=\"G_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1200,"wires":[["3c182d5b.28fc02","1c8df3d6.d7546c"]]},{"id":"1c8df3d6.d7546c","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/gyro","links":["26b05db9.863922"],"x":695,"y":1200,"wires":[]},{"id":"5fe97d23.14ce94","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/gyro/100100209","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1160,"wires":[["d25eb595.065288"]]},{"id":"e2fbb943.5b3068","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1280,"wires":[]},{"id":"5823d3cb.0a6e5c","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/acceleration/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":160,"y":1320,"wires":[["93c82e52.8c6b1"]]},{"id":"93c82e52.8c6b1","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/acceleration/','');\nmsg.sign=\"A_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1320,"wires":[["e2fbb943.5b3068","783c1f68.36d23"]]},{"id":"783c1f68.36d23","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/acceleration","links":["26b05db9.863922"],"x":695,"y":1320,"wires":[]},{"id":"6cbeddb.7886224","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/acceleration/100100210","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":1280,"wires":[["93c82e52.8c6b1"]]},{"id":"a29defb9.31a7","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1400,"wires":[]},{"id":"f1843eab.b3595","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/UV/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":130,"y":1440,"wires":[["cf05db38.694158"]]},{"id":"cf05db38.694158","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/UV/','');\nmsg.sign=\"U_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1440,"wires":[["a29defb9.31a7","41eb34ff.93b0fc"]]},{"id":"41eb34ff.93b0fc","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/UV","links":["26b05db9.863922"],"x":695,"y":1440,"wires":[]},{"id":"6b5acbcb.fd6c04","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/UV/100100211","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1400,"wires":[["cf05db38.694158"]]},{"id":"e47d039d.b556d","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1520,"wires":[]},{"id":"8d89da05.cf2218","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/E-field/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1560,"wires":[["5ac53a67.08e904"]]},{"id":"5ac53a67.08e904","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/E-field/','');\nmsg.sign=\"E_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1560,"wires":[["e47d039d.b556d","8ed89ab3.994a28"]]},{"id":"8ed89ab3.994a28","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/e-field","links":["26b05db9.863922"],"x":695,"y":1560,"wires":[]},{"id":"239121ef.f644fe","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/E-field/100100212","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":1520,"wires":[["5ac53a67.08e904"]]},{"id":"74300fb3.7f947","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1640,"wires":[]},{"id":"c2cfa92b.1a89c8","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/wind/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1680,"wires":[["5fa4f3d3.56770c"]]},{"id":"5fa4f3d3.56770c","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/wind/','');\nmsg.sign=\"W_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1680,"wires":[["74300fb3.7f947","93f8fe1d.93db8"]]},{"id":"93f8fe1d.93db8","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/wind","links":["26b05db9.863922"],"x":695,"y":1680,"wires":[]},{"id":"451ca113.3c79","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/wind/100100213","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1640,"wires":[["5fa4f3d3.56770c"]]},{"id":"9e546e58.e363a","type":"inject","z":"abe36278.d3a5e","name":"","topic":"100100200/LED","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":170,"y":2320,"wires":[["a58bbf61.81a32"]]},{"id":"d9a385bf.aaeeb8","type":"mqtt out","z":"abe36278.d3a5e","name":"actuator output","topic":"","qos":"2","retain":"","broker":"3bd1ba7.f516946","x":760,"y":2320,"wires":[]},{"id":"ccbba716.cc22c8","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"topic","targetType":"msg","x":780,"y":2280,"wires":[]},{"id":"a58bbf61.81a32","type":"template","z":"abe36278.d3a5e","name":"set MQTT topic actuators/","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"actuators/{{topic}}","output":"str","x":450,"y":2320,"wires":[["d9a385bf.aaeeb8","a012d4.1fdc0d3"]]},{"id":"a012d4.1fdc0d3","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"change","p":"topic","pt":"msg","from":"&#x2F;","fromt":"str","to":"/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":2280,"wires":[["ccbba716.cc22c8"]]},{"id":"f05e2964.31e858","type":"template","z":"9648297c.564688","name":"select * where refId matching","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM connections WHERE refid = {{payload}};","output":"str","x":600,"y":540,"wires":[["826bab90.379068"]]},{"id":"aecfc20a.3145b","type":"comment","z":"9648297c.564688","name":"Read specific id from connections table","info":"","x":170,"y":480,"wires":[]},{"id":"26b05db9.863922","type":"link in","z":"9648297c.564688","name":"IN select * where refid matching","links":["1c8df3d6.d7546c","41eb34ff.93b0fc","44c9b998.acdcd8","45bed4a7.8697bc","58100d27.50ff34","6c29658e.21602c","783c1f68.36d23","85fe13d4.8ba28","8ed89ab3.994a28","93f8fe1d.93db8","969a1c9f.d1b5a","b7c84551.fa16a8","c3f6e423.63bc68","dbcd8d10.d25ad"],"x":175,"y":540,"wires":[["f05e2964.31e858"]]},{"id":"a092a5a4.761be8","type":"link out","z":"9648297c.564688","name":"OUT select * where refid matching","links":["c7ec51ad.0e469"],"x":1015,"y":540,"wires":[]},{"id":"31b3456f.f2494a","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":580,"wires":[]},{"id":"77741176.bed1d","type":"function","z":"9648297c.564688","name":"","func":"msg.payload = \"2019-05-15 09:22:23\";\nreturn msg;","outputs":1,"noerr":0,"x":337,"y":1836,"wires":[["bf9987b6.27c558"]]},{"id":"d66327a3.080208","type":"inject","z":"9648297c.564688","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":187,"y":1816,"wires":[["77741176.bed1d"]]},{"id":"80080842.bed448","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":807,"y":1816,"wires":[]},{"id":"5ecfe411.eaf1dc","type":"inject","z":"9648297c.564688","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":367,"y":1896,"wires":[["bf9987b6.27c558"]]},{"id":"8a9578a9.1b6198","type":"comment","z":"9648297c.564688","name":"nochmal ansehen: wichtig für Graphen","info":"","x":257,"y":1776,"wires":[]},{"id":"764b2f44.ad68b","type":"comment","z":"9648297c.564688","name":"Write new value into <sign>_<refid> table","info":"","x":180,"y":660,"wires":[]},{"id":"394c898b.ebf396","type":"template","z":"9648297c.564688","name":"insert into T_<refId> new row","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO {{topic}}(timehr,timeunix, value) VALUES('{{timehr}}',{{timeunix}}, {{payload}});","output":"str","x":600,"y":780,"wires":[["bb21c98c.58ef08"]]},{"id":"c1aa9280.74ac1","type":"link in","z":"9648297c.564688","name":"IN insert into <sign>_<refId>","links":["7755a085.7aa94"],"x":175,"y":720,"wires":[["f148d746.454cf8"]]},{"id":"826bab90.379068","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":540,"wires":[["31b3456f.f2494a","a092a5a4.761be8"]]},{"id":"bb21c98c.58ef08","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT * FROM T_100100200;","name":"","x":870,"y":780,"wires":[["5b7333f5.7e894c"]]},{"id":"bf9987b6.27c558","type":"moment","z":"9648297c.564688","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":0,"adjType":"days","adjDir":"add","format":"","locale":"de_DE","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":567,"y":1816,"wires":[["80080842.bed448"]]},{"id":"be0c308c.3cc26","type":"template","z":"9648297c.564688","name":"Create Table IF NOT EXISTS","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"CREATE TABLE IF NOT EXISTS {{topic}}(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);","output":"str","x":600,"y":720,"wires":[["4bbb4773.862f68"]]},{"id":"4bbb4773.862f68","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT * FROM T_100100200;","name":"","x":870,"y":720,"wires":[["8d7606d9.2e8c28"]]},{"id":"f148d746.454cf8","type":"change","z":"9648297c.564688","name":"back up topic and payload","rules":[{"t":"move","p":"topic","pt":"msg","to":"toptmp","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"toptmp","tot":"msg"},{"t":"move","p":"payload","pt":"msg","to":"payltmp","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payltmp","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":720,"wires":[["be0c308c.3cc26","6ef98c26.1fcd74"]]},{"id":"8d7606d9.2e8c28","type":"change","z":"9648297c.564688","name":"retrieve original topic and payload","rules":[{"t":"move","p":"toptmp","pt":"msg","to":"topic","tot":"msg"},{"t":"delete","p":"toptmp","pt":"msg"},{"t":"move","p":"payltmp","pt":"msg","to":"payload","tot":"msg"},{"t":"delete","p":"payltmp","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":780,"wires":[["394c898b.ebf396"]]},{"id":"6ef98c26.1fcd74","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":680,"wires":[]},{"id":"11a059fb.cf4ec6","type":"comment","z":"abe36278.d3a5e","name":"generate time values ","info":"","x":130,"y":1800,"wires":[]},{"id":"9de244ed.1bf538","type":"comment","z":"abe36278.d3a5e","name":"listen on all possible sensor topics","info":"","x":160,"y":20,"wires":[]},{"id":"66abd8c0.e4bd08","type":"link out","z":"9648297c.564688","name":"OUT insert into <sign>_<refid>","links":["99fca6b2.dd3fb8","1aebe98c.177416","107b0207.e9426e"],"x":1015,"y":840,"wires":[]},{"id":"99fca6b2.dd3fb8","type":"link in","z":"64c3c505.631b7c","name":"IN dataUpdate dashboard","links":["66abd8c0.e4bd08","86a65c44.5bbb3"],"x":155,"y":540,"wires":[["492804a3.d94c1c"]]},{"id":"ea60e490.eafc68","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1330,"y":700,"wires":[]},{"id":"630a5be5.aab9d4","type":"template","z":"64c3c505.631b7c","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout where htmlid in ('val-{{payload}}-{{clientinfo.refid}}','chart-{{payload}}-{{clientinfo.refid}}') ;","output":"str","x":580,"y":500,"wires":[["f2e566fe.6f75b8"]]},{"id":"f2e566fe.6f75b8","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":540,"wires":[["dc33629b.dbfb3"]]},{"id":"dc33629b.dbfb3","type":"function","z":"64c3c505.631b7c","name":"sort layout data","func":"msg.dashboardData = [];\n\nmsg.payload.forEach(function(item, index) {\n    var uiType = item.htmlid.split(\"-\")[0];\n    var measType = item.htmlid.split(\"-\")[1];\n    var deviceId = item.htmlid.split(\"-\")[2];\n    \n    msg.dashboardData.push({\n        htmlId : item.htmlid,\n        numberGroup : item.numbergroup,\n        numberItem : item.numberitem,\n        uiType : uiType,\n        measType : measType,\n        deviceId : deviceId\n    });\n\n});\n\nmsg.payload = msg.dashboardData;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":540,"wires":[["c759fe4.227"]]},{"id":"c759fe4.227","type":"function","z":"64c3c505.631b7c","name":"forEach send select showndatapoints where refId matching","func":"msg.dashboardData.forEach(function(e) {\n    if (e.htmlId.includes(\"chart\")) {\n        node.send({\n        \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + e.deviceId.toString() + \";\",\n        \"dashboardData\": msg.dashboardData,\n        \"dashboardGroups\": msg.dashboardGroups,\n        \"_socketId\": msg._socketId\n        });\n    }\n});\n//return msg;","outputs":1,"noerr":0,"x":460,"y":600,"wires":[["be1a349e.324dc8"]]},{"id":"be1a349e.324dc8","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":600,"wires":[["74132b8d.85a0a4"]]},{"id":"74132b8d.85a0a4","type":"function","z":"64c3c505.631b7c","name":"include shownDataPoints in dashboardData","func":"//extract device id from sql query / topic\nvar deviceId = msg.topic.split(\"= \")[1].split(\";\")[0];\n\nmsg.dashboardData.forEach(function(e) {\n    if (e.htmlId.includes(\"chart\") && e.htmlId.includes(deviceId)) {\n        e.shownDataPoints = msg.payload[0].showndatapoints;\n        e.dispName = msg.payload[0].dispname;\n        e.deviceStatus = msg.payload[0].status;\n    }\n    else if(e.htmlId.includes(deviceId)) {\n        e.dispName = msg.payload[0].dispname;\n        e.deviceStatus = msg.payload[0].status;\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":600,"wires":[["969ef0b9.98767"]]},{"id":"969ef0b9.98767","type":"function","z":"64c3c505.631b7c","name":"forEach send select datapoints","func":"msg.dashboardData.forEach(function(e) {\n    var tempTopic = \"\";\n\n    if (e.htmlId.includes(\"chart\") && typeof e.shownDataPoints !== 'undefined') {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        \n        \n        node.send({\n            \"topic\": tempTopic,\n            \"curItem\": e.htmlId,\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"_socketId\": msg._socketId\n        });\n    }\n    else if (e.htmlId.includes(\"val\")) {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        \n        \n        node.send({\n            \"topic\": tempTopic,\n            \"curItem\": e.htmlId,\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"_socketId\": msg._socketId\n        });\n    }\n});\n\n//return msg;","outputs":1,"noerr":0,"x":550,"y":660,"wires":[["bb28b2b3.8f091"]]},{"id":"bb28b2b3.8f091","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":660,"wires":[["a3d62f1d.1d219"]]},{"id":"a3d62f1d.1d219","type":"function","z":"64c3c505.631b7c","name":"include DataPoints in dashboardData","func":"var setLastItem = false;\n\nmsg.dashboardData.forEach(function(e, i) {\n    //check if incoming data is intended for this element\n    if (msg.curItem == e.htmlId) {\n        //reverse data from db and save in dashboardData object\n        e.DataPoints = msg.payload.reverse();\n        \n        \n        //check if this element is the last possible match\n        if (i == (msg.dashboardData.length -1)) {\n            setLastItem = true;\n        }\n    }\n});\n\nif (setLastItem) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\nmsg.topic = \"updateData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1090,"y":660,"wires":[["d75bf08b.b2357","ea60e490.eafc68"]]},{"id":"11a60a24.ce4a16","type":"function","z":"64c3c505.631b7c","name":"set measurement type","func":"switch(msg.sign) {\n    case 'T_':\n        msg.payload = 'Temp';\n        break;\n    case 'H_':\n        msg.payload = 'Hum';\n        break;\n    case 'P_':\n        msg.payload = 'Press';\n        break;\n    case 'M_':\n        msg.payload = 'Mot';\n        break;\n    case 'B_':\n        msg.payload = 'But';\n        break;\n    case 'L_':\n        msg.payload = 'Lum';\n        break;\n    case 'D_':\n        msg.payload = 'Dist';\n        break;\n    case 'C_':\n        msg.payload = 'Co2';\n        break;\n    case 'V_':\n        msg.payload = 'Voc';\n        break;\n    case 'G_':\n        msg.payload = 'Gyro';\n        break;\n    case 'A_':\n        msg.payload = 'Acc';\n        break;\n    case 'U_':\n        msg.payload = 'Uv';\n        break;\n    case 'E_':\n        msg.payload = 'Efi';\n        break;\n    case 'W_':\n        msg.payload = 'Wind';\n        break;\n    default: \n        break;\n}\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[["630a5be5.aab9d4"]]},{"id":"d75bf08b.b2357","type":"link out","z":"64c3c505.631b7c","name":"OUT dataUpdate dashboard","links":["edc051f.3e1aab"],"x":1295,"y":660,"wires":[]},{"id":"edc051f.3e1aab","type":"link in","z":"64c3c505.631b7c","name":"IN dashboard","links":["d75bf08b.b2357","30e7088a.09cdf8"],"x":655,"y":440,"wires":[["a50781fb.ccf4a"]]},{"id":"e1531e42.63e6d","type":"link in","z":"64c3c505.631b7c","name":"IN discoveryUpdate deviceoverview","links":["fa0385b3.254ec8"],"x":155,"y":1440,"wires":[["63d676ca.021d78"]]},{"id":"fa0385b3.254ec8","type":"link out","z":"18000974.c23df7","name":"OUT discovery","links":["5d443021.47506","e1531e42.63e6d","2fc42486.5b4d6c"],"x":735,"y":380,"wires":[]},{"id":"5d443021.47506","type":"link in","z":"64c3c505.631b7c","name":"IN discoveryUpdate dashboard","links":["fa0385b3.254ec8"],"x":155,"y":740,"wires":[["22786e64.a75a82"]]},{"id":"afc4b751.6361a8","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":1380,"wires":[]},{"id":"63d676ca.021d78","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1440,"wires":[["aa9c673f.1de048"]]},{"id":"aa9c673f.1de048","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1440,"wires":[["d3896035.b2a13"]]},{"id":"d3896035.b2a13","type":"function","z":"64c3c505.631b7c","name":"sort overviewData","func":"msg.overviewData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.overviewData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\nmsg.topic = \"discoveryData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1440,"wires":[["3a64a7b8.378fe8","afc4b751.6361a8"]]},{"id":"104bc906.a292d7","type":"comment","z":"64c3c505.631b7c","name":"DEVICESETTINGS Autosending on page load","info":"","x":190,"y":1600,"wires":[]},{"id":"28ee813.65cc47e","type":"comment","z":"64c3c505.631b7c","name":"DEVICESETTINGS Send new data / Update","info":"","x":190,"y":1900,"wires":[]},{"id":"2fc42486.5b4d6c","type":"link in","z":"64c3c505.631b7c","name":"IN discoveryUpdate devicesettings","links":["fa0385b3.254ec8"],"x":155,"y":1940,"wires":[["bc9af036.42bbc"]]},{"id":"1aebe98c.177416","type":"link in","z":"64c3c505.631b7c","name":"IN dataUpdate devicesettings","links":["66abd8c0.e4bd08","86a65c44.5bbb3"],"x":155,"y":2080,"wires":[["d4c2cf53.a3747"]]},{"id":"bc9af036.42bbc","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1940,"wires":[["a64c354d.5282b8"]]},{"id":"a64c354d.5282b8","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1940,"wires":[["3e24cc4a.a5e414"]]},{"id":"3e24cc4a.a5e414","type":"function","z":"64c3c505.631b7c","name":"sort settingsInputData, forEach send lastmsgtime","func":"var settingsInputData = [];\n\nmsg.payload.forEach(function(e,i) {\n    settingsInputData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status,\n        interval: e.curinterval,\n        units: e.curunit,\n        shownDataPoints: e.showndatapoints,\n        isNotifying: e.isnotifying,\n        lastReceivedVal: e.lastmsgtime,\n        manControl: e.mancontrol,\n        linkedTo: e.linkedto,\n        threshold: e.threshold,\n        linkRule: e.linkrule,\n        linkedMeas: e.linkedMeas\n    });\n    \n    node.send({\n        payload: e.lastmsgtime,\n        topic: e.refid,\n        settingsInputData: settingsInputData,\n        dataLength: msg.payload.length\n    });\n});\n","outputs":1,"noerr":0,"x":1130,"y":1940,"wires":[["9cb3c00a.1a36a"]]},{"id":"9cb3c00a.1a36a","type":"moment","z":"64c3c505.631b7c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"0","adjType":"hours","adjDir":"add","format":"fromNow","locale":"en_EN","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":800,"y":2000,"wires":[["cc25f5d.9d42808"]]},{"id":"cc25f5d.9d42808","type":"function","z":"64c3c505.631b7c","name":"attach formatted lastmsgtime","func":"\nmsg.settingsInputData.forEach(function(element, index) {\n    if (element.deviceId == msg.topic) {\n        element.lastReceivedVal = msg.payload;\n    }\n});\n\nmsg.topic = \"discoveryData\";\n\nif (msg.settingsInputData.length == msg.dataLength) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":2000,"wires":[["78e9062f.5aeaa8"]]},{"id":"78e9062f.5aeaa8","type":"link out","z":"64c3c505.631b7c","name":"OUT discoveryUpdate devicesettings","links":["2545365b.1d7f3a"],"x":1235,"y":2000,"wires":[]},{"id":"2545365b.1d7f3a","type":"link in","z":"64c3c505.631b7c","name":"IN devicesettings","links":["78e9062f.5aeaa8","303e7c92.40c714"],"x":655,"y":1800,"wires":[["b3315e46.18a65"]]},{"id":"d4c2cf53.a3747","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":2080,"wires":[["54b1a39e.fcc13c"]]},{"id":"54b1a39e.fcc13c","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2080,"wires":[["90fb8221.8062"]]},{"id":"90fb8221.8062","type":"function","z":"64c3c505.631b7c","name":"sort settingsInputData, forEach send lastmsgtime","func":"var settingsInputData = [];\n\nmsg.payload.forEach(function(e,i) {\n    settingsInputData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status,\n        interval: e.curinterval,\n        units: e.curunit,\n        shownDataPoints: e.showndatapoints,\n        isNotifying: e.isnotifying,\n        lastReceivedVal: e.lastmsgtime,\n        manControl: e.mancontrol,\n        linkedTo: e.linkedto,\n        threshold: e.threshold,\n        linkRule: e.linkrule,\n        linkedMeas: e.linkedMeas\n    });\n    \n    node.send({\n        payload: e.lastmsgtime,\n        topic: e.refid,\n        settingsInputData: settingsInputData,\n        dataLength: msg.payload.length\n    });\n});\n","outputs":1,"noerr":0,"x":1130,"y":2080,"wires":[["2800cbd9.6d0ff4"]]},{"id":"2800cbd9.6d0ff4","type":"moment","z":"64c3c505.631b7c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"0","adjType":"hours","adjDir":"add","format":"fromNow","locale":"en_EN","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":800,"y":2140,"wires":[["508609d1.a9b2a8"]]},{"id":"508609d1.a9b2a8","type":"function","z":"64c3c505.631b7c","name":"attach formatted lastmsgtime","func":"\nmsg.settingsInputData.forEach(function(element, index) {\n    if (element.deviceId == msg.topic) {\n        element.lastReceivedVal = msg.payload;\n    }\n});\n\nmsg.topic = \"updateData\";\n\nif (msg.settingsInputData.length == msg.dataLength) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":2140,"wires":[["303e7c92.40c714","c6ae4865.a648f8"]]},{"id":"303e7c92.40c714","type":"link out","z":"64c3c505.631b7c","name":"OUT dataUpdate devicesettings","links":["2545365b.1d7f3a"],"x":1235,"y":2140,"wires":[]},{"id":"c6ae4865.a648f8","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":2180,"wires":[]},{"id":"5b7333f5.7e894c","type":"template","z":"9648297c.564688","name":"update lastmsgtime","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set lastmsgtime = {{timeunix}} where refid = {{clientinfo.refid}};","output":"str","x":570,"y":840,"wires":[["108182e2.a066ad"]]},{"id":"46ac6b7e.edb064","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":880,"wires":[]},{"id":"108182e2.a066ad","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT * FROM T_100100200;","name":"","x":870,"y":840,"wires":[["46ac6b7e.edb064","66abd8c0.e4bd08"]]},{"id":"107b0207.e9426e","type":"link in","z":"64c3c505.631b7c","name":"IN dataUpdate deviceoverview","links":["66abd8c0.e4bd08","86a65c44.5bbb3"],"x":155,"y":1520,"wires":[["ee2c72ca.1c80c"]]},{"id":"ee2c72ca.1c80c","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1520,"wires":[["b20c4aec.b99248"]]},{"id":"b20c4aec.b99248","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1520,"wires":[["4b3bc02e.ec70a"]]},{"id":"4b3bc02e.ec70a","type":"function","z":"64c3c505.631b7c","name":"sort overviewData","func":"msg.overviewData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.overviewData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\nmsg.topic = \"updateData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1520,"wires":[["e3a32f4d.b6ed4"]]},{"id":"e3a32f4d.b6ed4","type":"link out","z":"64c3c505.631b7c","name":"OUT dataUpdate deviceoverview","links":["c162d6c0.a00c08"],"x":1175,"y":1520,"wires":[]},{"id":"c162d6c0.a00c08","type":"link in","z":"64c3c505.631b7c","name":"IN deviceoverview","links":["e3a32f4d.b6ed4"],"x":655,"y":1320,"wires":[["3a64a7b8.378fe8"]]},{"id":"e12413db.7cac7","type":"comment","z":"abe36278.d3a5e","name":"Disconnect-Watchdog","info":"","x":120,"y":2560,"wires":[]},{"id":"1ea2373a.a33e59","type":"inject","z":"abe36278.d3a5e","name":"","topic":"","payload":"","payloadType":"date","repeat":"20","crontab":"","once":true,"onceDelay":0.1,"x":150,"y":2620,"wires":[["f65ed956.c5ae78","94064ff7.1004"]]},{"id":"3c539169.6c813e","type":"template","z":"abe36278.d3a5e","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":2620,"wires":[["577dedf.b709114"]]},{"id":"577dedf.b709114","type":"sqlite","z":"abe36278.d3a5e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2620,"wires":[["3e322741.89f918"]]},{"id":"3e322741.89f918","type":"function","z":"abe36278.d3a5e","name":"set timeout if needed","func":"msg.payload.forEach(function(element, index) {\n    var backupStatus = element.status;\n    if (element.lastmsgtime < (msg.time - 2*element.curinterval*1000)) {\n        // last msg not received in time, timeout required\n        element.status = \"disconnected\";\n    }\n    else {\n        element.status = \"connected\";\n    }\n    \n    var hasChangedStatus = false;\n    if (element.status != backupStatus) {\n        hasChangedStatus = true;\n    }\n    \n    node.send({\n        payload: element.status,\n        refid: element.refid,\n        changedStatus: hasChangedStatus\n    });\n});","outputs":1,"noerr":0,"x":1040,"y":2620,"wires":[["d0befa8a.96f078"]]},{"id":"f65ed956.c5ae78","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"set","p":"time","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":2620,"wires":[["3c539169.6c813e"]]},{"id":"d0befa8a.96f078","type":"template","z":"abe36278.d3a5e","name":"update status","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set status = '{{payload}}' where refid = {{refid}};","output":"str","x":600,"y":2680,"wires":[["539ccdd4.08a824"]]},{"id":"539ccdd4.08a824","type":"sqlite","z":"abe36278.d3a5e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2680,"wires":[["3fe04bb3.af07c4"]]},{"id":"86a65c44.5bbb3","type":"link out","z":"abe36278.d3a5e","name":"OUT timeout","links":["1aebe98c.177416","107b0207.e9426e","99fca6b2.dd3fb8"],"x":1215,"y":2680,"wires":[]},{"id":"3fe04bb3.af07c4","type":"function","z":"abe36278.d3a5e","name":"check if status changed","func":"if (msg.changedStatus) {\n    return msg;\n}","outputs":1,"noerr":0,"x":1050,"y":2680,"wires":[["86a65c44.5bbb3","2ed331a1.2642ee"]]},{"id":"2ed331a1.2642ee","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1250,"y":2720,"wires":[]},{"id":"94064ff7.1004","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":330,"y":2680,"wires":[]},{"id":"492804a3.d94c1c","type":"switch","z":"64c3c505.631b7c","name":"check msg.sign","property":"sign","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":540,"wires":[["11a60a24.ce4a16"],["26883841.ca3808"]]},{"id":"26883841.ca3808","type":"template","z":"64c3c505.631b7c","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout where htmlid like '%{{refid}}';","output":"str","x":580,"y":540,"wires":[["f2e566fe.6f75b8"]]},{"id":"5674df64.5e558","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1330,"y":1140,"wires":[]},{"id":"22786e64.a75a82","type":"template","z":"64c3c505.631b7c","name":"select from connections where refid","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections where refid = {{payload}};","output":"str","x":540,"y":740,"wires":[["973fe540.4affa8"]]},{"id":"973fe540.4affa8","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":740,"wires":[["f3992791.a2c738"]]},{"id":"f3992791.a2c738","type":"function","z":"64c3c505.631b7c","name":"calc itemCount to add to dashboard","func":"if (msg.payload[0].refid == msg.curRefId) {\n    var measurandCount = msg.payload[0].curunit.split('').length;\n    if (msg.payload[0].types != \"MPU6050\") {\n        msg.itemCount = 2 * measurandCount;\n    }\n    else {\n        msg.itemCount = 2 * 3 * measurandCount;\n    }\n    msg.connectionData = msg.payload;\n    \n    return msg;\n}","outputs":1,"noerr":0,"x":1080,"y":740,"wires":[["5f642d59.b58a64"]]},{"id":"bf68a83a.a68d08","type":"function","z":"64c3c505.631b7c","name":"insert new group into uigroups","func":"msg.lastGroup = msg.payload;\n\nif (typeof msg.lastGroup !== 'undefined' && (msg.lastGroup.length > 0)) {\n    msg.newGroupNumber = (parseInt(msg.lastGroup[0].htmlid)+1);\n}\nelse {\n    msg.newGroupNumber = 1;\n}\n\nlet query = \"insert into uigroups(htmlid,name,items) values('\" \n            + msg.newGroupNumber + \"','\" \n            + msg.connectionData[0].dispname + \"','\";\n\nlet itemList = [];\n\nfor (let i = 0; i < (msg.itemCount / 2); i++) {\n    query += \"VC\";\n    itemList.push(\"value\");\n    itemList.push(\"chart\");\n}\n\nquery += \"');\";\n\nmsg.topic = query;\nmsg.itemList = itemList;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":860,"wires":[["ede378f9.b06468"]]},{"id":"5f642d59.b58a64","type":"template","z":"64c3c505.631b7c","name":"select highest htmlid from uigroups","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uigroups order by cast(htmlid as integer) desc limit 1;","output":"str","x":540,"y":800,"wires":[["b3be6bd9.955e68"]]},{"id":"b3be6bd9.955e68","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":800,"wires":[["bf68a83a.a68d08"]]},{"id":"ede378f9.b06468","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":860,"wires":[["b7daa54e.d9bae8"]]},{"id":"b7daa54e.d9bae8","type":"function","z":"64c3c505.631b7c","name":"insert new items into uilayout","func":"let listVal = [];\nlet listChart = [];\n\nfor (let i = 0; i < msg.itemCount; i++) {\n    let query = \"insert into uilayout(htmlid,numbergroup,numberitem) values('\";\n    let htmlId = \"\";\n    let numberGroup = msg.newGroupNumber;\n    let numberItem = (i+1);\n    let uiType = \"\";\n    let measType = \"\";\n    let deviceId = msg.connectionData[0].refid;\n    \n    \n    if ((i % 2) === 0) {\n        //item is value (default)\n        htmlId += \"val-\";\n        uiType = \"val\";\n    }\n    else if ((i % 2) == 1) {\n        // item is chart (default)\n        htmlId += \"chart-\";\n        uiType = \"chart\";\n    }\n    \n    \n    \n    switch(msg.connectionData[0].types) {\n        case 'DHT11':\n            htmlId += setMeasurementType(i, \"Temp\", \"Hum\");\n            break;\n        case 'BME280':\n            htmlId += setMeasurementType(i, \"Temp\", \"Hum\", \"Press\");\n            break;\n        case 'P_':\n            msg.payload = 'Press';\n            break;\n        case 'M_':\n            msg.payload = 'Mot';\n            break;\n        case 'B_':\n            msg.payload = 'But';\n            break;\n        case 'L_':\n            msg.payload = 'Lum';\n            break;\n        case 'D_':\n            msg.payload = 'Dist';\n            break;\n        case 'C_':\n            msg.payload = 'Co2';\n            break;\n        case 'V_':\n            msg.payload = 'Voc';\n            break;\n        case 'G_':\n            msg.payload = 'Gyro';\n            break;\n        case 'A_':\n            msg.payload = 'Acc';\n            break;\n        case 'U_':\n            msg.payload = 'Uv';\n            break;\n        case 'E_':\n            msg.payload = 'Efi';\n            break;\n        case 'W_':\n            msg.payload = 'Wind';\n            break;\n        default: \n            break;\n    }\n\n    measType = htmlId.split('-')[1];\n\n    htmlId += \"-\" + deviceId;\n    query += htmlId + \"',\";\n    \n    query += numberGroup + \",\";\n    \n    query += numberItem + \");\";\n    \n    node.send({\n        topic: query,\n        connectionData: msg.connectionData,\n        curRefId: msg.curRefId,\n        itemCount: msg.itemCount,\n        itemList: msg.itemList,\n        itemData: {\n            htmlId: htmlId,\n            numberGroup: numberGroup,\n            numberItem: numberItem,\n            uiType: uiType,\n            measType: measType,\n            deviceId: deviceId\n        }\n    });\n}\n\n\nfunction setMeasurementType(i, text1=\"\", text2=\"\", text3=\"\", text4=\"\", text5=\"\", text6=\"\") {\n    switch(i) {\n        case 0:\n        case 1:\n            return text1;\n            break;\n        case 2:\n        case 3:\n            return text2;\n            break;\n        case 4:\n        case 5:\n            return text3;\n            break;\n        case 6:\n        case 7:\n            return text4;\n            break;\n        case 8:\n        case 9:\n            return text5;\n            break;\n        case 10:\n        case 11:\n            return text6;\n            break;\n        default:\n            return \"\";\n            break;\n    }\n}","outputs":1,"noerr":0,"x":560,"y":920,"wires":[["b27ba09b.994ea"]]},{"id":"b27ba09b.994ea","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":920,"wires":[["5c406532.66d80c"]]},{"id":"d49032ea.7082","type":"comment","z":"9648297c.564688","name":"Change connections table","info":"","x":350,"y":980,"wires":[]},{"id":"6d6df8cb.3597b8","type":"link in","z":"9648297c.564688","name":"IN change connections table","links":["49773ac0.0bd974"],"x":335,"y":1040,"wires":[["b82b2ed0.9147e"]]},{"id":"1a859347.d5856d","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1110,"y":1100,"wires":[]},{"id":"95afafe.5bfa05","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1040,"wires":[["c8645752.6c34a8"]]},{"id":"d9550595.3b7678","type":"template","z":"9648297c.564688","name":"change DisplayName","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set dispname = '{{dispName}}' where refid = {{deviceId}};","output":"str","x":620,"y":1040,"wires":[["95afafe.5bfa05"]]},{"id":"b82b2ed0.9147e","type":"function","z":"9648297c.564688","name":"","func":"msg.deviceId=msg.payload.deviceId;\nmsg.dispName=msg.payload.dispName\nmsg.isVisible=msg.payload.isVisible\nmsg.shownDataPoints=msg.payload.shownDataPoints\nmsg.interval=msg.payload.interval\nreturn msg","outputs":1,"noerr":0,"x":430,"y":1040,"wires":[["d9550595.3b7678"]]},{"id":"c8645752.6c34a8","type":"template","z":"9648297c.564688","name":"change Visibility","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set isvisible = '{{isVisible}}' where refid = {{deviceId}};","output":"str","x":600,"y":1100,"wires":[["b1ec9b83.95c788"]]},{"id":"b1ec9b83.95c788","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1100,"wires":[["ba70bb88.3626b8"]]},{"id":"ba70bb88.3626b8","type":"template","z":"9648297c.564688","name":"change curinterval","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set curinterval = '{{interval}}' where refid = {{deviceId}};","output":"str","x":610,"y":1160,"wires":[["13c19a31.a7be06"]]},{"id":"13c19a31.a7be06","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1160,"wires":[["ea1c2887.709fa8"]]},{"id":"ea1c2887.709fa8","type":"template","z":"9648297c.564688","name":"change shownDataPoints","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set showndatapoints = '{{shownDataPoints}}' where refid = {{deviceId}};","output":"str","x":630,"y":1220,"wires":[["2c3bf1ac.a0439e"]]},{"id":"2c3bf1ac.a0439e","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1220,"wires":[["1a859347.d5856d","d55fe17b.9539a"]]},{"id":"5c16ab35.060b54","type":"link out","z":"9648297c.564688","name":"OUT curlinterval","links":["d482aed4.c0a7d"],"x":875,"y":1280,"wires":[]},{"id":"d55fe17b.9539a","type":"template","z":"9648297c.564688","name":"","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"interval/{{deviceId}}","output":"str","x":580,"y":1280,"wires":[["c831fb17.295728"]]},{"id":"c831fb17.295728","type":"template","z":"9648297c.564688","name":"","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{interval}}","output":"str","x":760,"y":1280,"wires":[["5c16ab35.060b54"]]},{"id":"7f1876b0.4de788","type":"mqtt out","z":"abe36278.d3a5e","name":"curinvervall output","topic":"","qos":"2","retain":"","broker":"3bd1ba7.f516946","x":830,"y":2160,"wires":[]},{"id":"35190b56.673ed4","type":"debug","z":"abe36278.d3a5e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":790,"y":2120,"wires":[]},{"id":"8bd16f84.149d7","type":"template","z":"abe36278.d3a5e","name":"add config/interval/","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"config/interval/{{topic}}","output":"str","x":390,"y":2160,"wires":[["c44c6146.eee37"]]},{"id":"d482aed4.c0a7d","type":"link in","z":"abe36278.d3a5e","name":"IN curlinterval","links":["5c16ab35.060b54"],"x":195,"y":2160,"wires":[["8bd16f84.149d7"]]},{"id":"b3976bd9.d572b8","type":"inject","z":"abe36278.d3a5e","name":"","topic":"100100200","payload":"24","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":210,"y":2120,"wires":[["8bd16f84.149d7"]]},{"id":"c44c6146.eee37","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"change","p":"topic","pt":"msg","from":"&#x2F;","fromt":"str","to":"/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":610,"y":2160,"wires":[["7f1876b0.4de788","35190b56.673ed4"]]},{"id":"49773ac0.0bd974","type":"link out","z":"64c3c505.631b7c","name":"OUT devicesettings","links":["6d6df8cb.3597b8"],"x":955,"y":1760,"wires":[]},{"id":"ee9f70a8.3abc6","type":"function","z":"64c3c505.631b7c","name":"forEach send check if table exists","func":"msg.dashboardData.forEach(function(e) {\n    var tempTopic = \"\";\n\n    if (e.htmlId.includes(\"Hum\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS H_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Temp\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS T_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Press\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS P_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Mot\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS M_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"But\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS B_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Lum\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS L_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Dist\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS D_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Co2\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS C_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Voc\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS V_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Gyro\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS G_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Acc\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS A_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Uv\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS U_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Efi\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS E_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Wind\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS W_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    \n    node.send({\n        \"topic\": tempTopic,\n        \"curItem\": e.htmlId,\n        \"dashboardData\": msg.dashboardData,\n        \"dashboardGroups\": msg.dashboardGroups,\n        \"_socketId\": msg._socketId\n    });\n});\n\n//return msg;","outputs":1,"noerr":0,"x":540,"y":240,"wires":[["6a4dcbb5.7ea774"]]},{"id":"6a4dcbb5.7ea774","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":240,"wires":[["34b6f494.3bb2bc"]]},{"id":"30e7088a.09cdf8","type":"link out","z":"64c3c505.631b7c","name":"OUT discoverUpdate dashboard","links":["edc051f.3e1aab"],"x":1295,"y":1100,"wires":[]},{"id":"5c406532.66d80c","type":"function","z":"64c3c505.631b7c","name":"send select showndatapoints where refId matching","func":"if (msg.itemData.htmlId.includes(\"chart\")) {\n        node.send({\n        \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + msg.itemData.deviceId.toString() + \";\",\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n        });\n}\nelse if (msg.itemData.htmlId.includes(\"val\")) {\n        node.send({\n        \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + msg.itemData.deviceId.toString() + \";\",\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n        });\n}\n\n//return msg;","outputs":1,"noerr":0,"x":490,"y":980,"wires":[["8e011702.be6ac8"]]},{"id":"8e011702.be6ac8","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":980,"wires":[["cd000c3e.b52e"]]},{"id":"cd000c3e.b52e","type":"function","z":"64c3c505.631b7c","name":"include shownDataPoints in dashboardData","func":"//extract device id from sql query / topic\nvar deviceId = msg.topic.split(\"= \")[1].split(\";\")[0];\n\nif (msg.itemData.htmlId.includes(\"chart\") && msg.itemData.htmlId.includes(deviceId)) {\n    msg.itemData.shownDataPoints = msg.payload[0].showndatapoints;\n    msg.itemData.dispName = msg.payload[0].dispname;\n    msg.itemData.deviceStatus = msg.payload[0].status;\n}\nelse if(msg.itemData.htmlId.includes(deviceId)) {\n    msg.itemData.dispName = msg.payload[0].dispname;\n    msg.itemData.deviceStatus = msg.payload[0].status;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1110,"y":980,"wires":[["71d6c0d9.cb9c3"]]},{"id":"71d6c0d9.cb9c3","type":"function","z":"64c3c505.631b7c","name":"send check if table exists","func":"var tempTopic = \"\";\n\nif (msg.itemData.htmlId.includes(\"Hum\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS H_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Temp\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS T_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Press\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS P_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Mot\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS M_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"But\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS B_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Lum\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS L_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Dist\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS D_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Co2\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS C_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Voc\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS V_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Gyro\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS G_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Acc\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS A_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Uv\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS U_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Efi\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS E_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Wind\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS W_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\n\nnode.send({\n    \"topic\": tempTopic,\n    \"curItem\": msg.itemData.htmlId,\n    \"itemData\": msg.itemData,\n    \"itemList\": msg.itemList,\n    \"_socketId\": msg._socketId\n});\n\n//return msg;","outputs":1,"noerr":0,"x":570,"y":1040,"wires":[["3c02cad7.54df06"]]},{"id":"3c02cad7.54df06","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1040,"wires":[["876c68c.3d5df98"]]},{"id":"876c68c.3d5df98","type":"function","z":"64c3c505.631b7c","name":"send select datapoints","func":"var tempTopic = \"\";\n\nif (msg.itemData.htmlId.includes(\"chart\") && typeof msg.itemData.shownDataPoints !== 'undefined') {\n    if (msg.itemData.htmlId.includes(\"Hum\")) {\n        tempTopic = \"select * from H_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Temp\")) {\n        tempTopic = \"select * from T_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Press\")) {\n        tempTopic = \"select * from P_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Mot\")) {\n        tempTopic = \"select * from M_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"But\")) {\n        tempTopic = \"select * from B_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Lum\")) {\n        tempTopic = \"select * from L_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Dist\")) {\n        tempTopic = \"select * from D_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Co2\")) {\n        tempTopic = \"select * from C_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Voc\")) {\n        tempTopic = \"select * from V_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Gyro\")) {\n        tempTopic = \"select * from G_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Acc\")) {\n        tempTopic = \"select * from A_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Uv\")) {\n        tempTopic = \"select * from U_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Efi\")) {\n        tempTopic = \"select * from E_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Wind\")) {\n        tempTopic = \"select * from W_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    \n    node.send({\n        \"topic\": tempTopic,\n        \"curItem\": msg.itemData.htmlId,\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n    });\n}\nelse if (msg.itemData.htmlId.includes(\"val\")) {\n    if (msg.itemData.htmlId.includes(\"Hum\")) {\n        tempTopic = \"select * from H_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Temp\")) {\n        tempTopic = \"select * from T_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Press\")) {\n        tempTopic = \"select * from P_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Mot\")) {\n        tempTopic = \"select * from M_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"But\")) {\n        tempTopic = \"select * from B_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Lum\")) {\n        tempTopic = \"select * from L_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Dist\")) {\n        tempTopic = \"select * from D_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Co2\")) {\n        tempTopic = \"select * from C_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Voc\")) {\n        tempTopic = \"select * from V_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Gyro\")) {\n        tempTopic = \"select * from G_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Acc\")) {\n        tempTopic = \"select * from A_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Uv\")) {\n        tempTopic = \"select * from U_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Efi\")) {\n        tempTopic = \"select * from E_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Wind\")) {\n        tempTopic = \"select * from W_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    \n    \n    node.send({\n        \"topic\": tempTopic,\n        \"curItem\": msg.itemData.htmlId,\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n    });\n}\n\n//return msg;","outputs":1,"noerr":0,"x":580,"y":1100,"wires":[["928ecd4e.63278"]]},{"id":"928ecd4e.63278","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1100,"wires":[["63c8c9f2.fd5608"]]},{"id":"63c8c9f2.fd5608","type":"function","z":"64c3c505.631b7c","name":"include DataPoints in itemData","func":"if (msg.curItem == msg.itemData.htmlId) {\n    //reverse data from db and save in dashboardData object\n    msg.itemData.DataPoints = msg.payload.reverse();\n}\n\nmsg.topic = \"discoveryData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":1100,"wires":[["5674df64.5e558","30e7088a.09cdf8"]]},{"id":"33f633a.dfd0acc","type":"comment","z":"64c3c505.631b7c","name":"TESTEN Teilweise werden irgendwie...","info":"...zwei uigroups und alle items doppelt angelegt.\nbei einem discovery","x":230,"y":840,"wires":[]}]