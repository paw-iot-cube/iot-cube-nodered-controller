[{"id":"18000974.c23df7","type":"tab","label":"Discovery","disabled":false,"info":""},{"id":"abe36278.d3a5e","type":"tab","label":"MQTT pubsub","disabled":false,"info":""},{"id":"9648297c.564688","type":"tab","label":"Databases","disabled":false,"info":""},{"id":"64c3c505.631b7c","type":"tab","label":"Website","disabled":false,"info":""},{"id":"57a86fb4.0e54e","type":"tab","label":"CSV generation","disabled":false,"info":""},{"id":"3bd1ba7.f516946","type":"mqtt-broker","z":"","name":"","broker":"localhost","port":"1883","clientid":"","usetls":false,"compatmode":true,"keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthPayload":"","closeTopic":"","closeQos":"0","closePayload":"","willTopic":"","willQos":"0","willPayload":""},{"id":"d2b7de10.e07f8","type":"sqlitedb","z":"","db":"/home/pi/reference.db","mode":"RWC"},{"id":"667529e2.c47648","type":"sqlitedb","z":"","db":"/home/pi/data.db","mode":"RWC"},{"id":"b94e38e2.fe81f8","type":"mqtt in","z":"18000974.c23df7","name":"","topic":"discovery/device","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":100,"y":80,"wires":[["59cc4aa9.8904e4"]]},{"id":"3c018d1a.074792","type":"mqtt out","z":"18000974.c23df7","name":"","topic":"discovery/master","qos":"","retain":"","broker":"3bd1ba7.f516946","x":1250,"y":320,"wires":[]},{"id":"db589ebc.537b3","type":"comment","z":"18000974.c23df7","name":"Discovery of new sensors","info":"","x":130,"y":40,"wires":[]},{"id":"4ffeb151.ffa42","type":"template","z":"18000974.c23df7","name":"select * from sensactref","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from sensactref;","output":"str","x":350,"y":200,"wires":[["45772752.7809f8"]]},{"id":"a257206e.40346","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"txpayload","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":80,"wires":[["bd91c6b2.706d88"]]},{"id":"45772752.7809f8","type":"sqlite","z":"18000974.c23df7","mydb":"d2b7de10.e07f8","sqlquery":"msg.topic","sql":"","name":"","x":600,"y":200,"wires":[["8526f97a.fb6c28"]]},{"id":"c3287a48.4cf568","type":"function","z":"18000974.c23df7","name":"add to db with default vals","func":"msg.reference.forEach(function(element, index) {\n    if (element.name == msg.txpayload.name && !msg.ips.includes(msg.txpayload.ip)) {\n        msg.test = 1;\n        if (msg.payload.length > 0) {\n            msg.curRefId = msg.payload[0].refid+1;\n        }\n        else {\n            msg.curRefId = 10;\n        }\n        \n        msg.topic = \"insert into connections(IP, refid, category, types, curunit, curinterval, dispname, status, islogged, isnotifying, showndatapoints, isvisible, lastmsgtime) values('\" \n                    + msg.txpayload.ip + \"', \" + msg.curRefId + \", '\"+ element.category + \"', '\" + msg.txpayload.name + \"', '\" + element.defaultunits + \"', \" + element.defaultinterval + \", '\" + msg.txpayload.name\n                    + \"', 'connected', 1, 0, 5, 1, \" + msg.timeunix +\");\";\n        return;\n    }\n    else if (msg.ips.includes(msg.txpayload.ip)) {\n        msg.test = 2;\n        // ip already registered, return already existing id\n        msg.topic = \"select refid from connections where IP = '\" + msg.txpayload.ip + \"';\";\n        return;\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":850,"y":320,"wires":[["fc5a9f9b.c2bee"]]},{"id":"ce955e91.c5ebc","type":"debug","z":"18000974.c23df7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1210,"y":440,"wires":[]},{"id":"59cc4aa9.8904e4","type":"json","z":"18000974.c23df7","name":"","property":"payload","action":"","pretty":false,"x":270,"y":80,"wires":[["a257206e.40346"]]},{"id":"8cc55e37.ab3e","type":"template","z":"18000974.c23df7","name":"select highest refid from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select refid from connections order by refid desc limit 1;","output":"str","x":310,"y":320,"wires":[["b4a3f2c3.a076"]]},{"id":"b4a3f2c3.a076","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":320,"wires":[["c3287a48.4cf568"]]},{"id":"8526f97a.fb6c28","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"reference","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":830,"y":200,"wires":[["cc1aebce.7fb918"]]},{"id":"fc5a9f9b.c2bee","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":380,"wires":[["9341afd9.057e4"]]},{"id":"18ddd4c4.2a3f6b","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"curRefId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":380,"wires":[["3c018d1a.074792","3c1c50e0.9d134","ce955e91.c5ebc"]]},{"id":"bd91c6b2.706d88","type":"template","z":"18000974.c23df7","name":"select IP from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select IP from connections;","output":"str","x":340,"y":140,"wires":[["3138b729.b8b6e8"]]},{"id":"3138b729.b8b6e8","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":140,"wires":[["62c859dd.6013d8"]]},{"id":"62c859dd.6013d8","type":"function","z":"18000974.c23df7","name":"reordering array","func":"var tempArray = []\n\nmsg.payload.forEach(function(element, index) {\n    if (!tempArray.includes(element.IP)) {\n        tempArray.push(element.IP);\n    }\n});\n\nmsg.ips = tempArray;\nreturn msg;","outputs":1,"noerr":0,"x":820,"y":140,"wires":[["4ffeb151.ffa42"]]},{"id":"3c1c50e0.9d134","type":"link out","z":"18000974.c23df7","name":"OUT discovery","links":["188d5e14.94cbb2","37589543.6db32a","5fe6fbac.5edf24"],"x":1175,"y":380,"wires":[]},{"id":"4b2c8c2c.a62804","type":"debug","z":"18000974.c23df7","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1010,"y":560,"wires":[]},{"id":"ec1b5991.4054c8","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":80,"wires":[]},{"id":"c4868251.c87dc","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/temperature/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":160,"y":120,"wires":[["26268a1e.5064b6"]]},{"id":"26268a1e.5064b6","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/temperature/','');\nmsg.sign=\"T_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":120,"wires":[["ec1b5991.4054c8","a0a4ea84.688238"]]},{"id":"a0a4ea84.688238","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/temperature","links":["f50b416e.1fdee"],"x":695,"y":120,"wires":[]},{"id":"c7a7d482.844708","type":"link in","z":"abe36278.d3a5e","name":"IN sensors/+ arranged","links":["7d4be22f.eef0bc"],"x":175,"y":2180,"wires":[["40283e4f.163fb"]]},{"id":"40283e4f.163fb","type":"change","z":"abe36278.d3a5e","name":"rearrange msg properties","rules":[{"t":"set","p":"topic","pt":"msg","to":"payload[0].refid","tot":"msg"},{"t":"set","p":"clientinfo","pt":"msg","to":"payload[0]","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"txpayload","tot":"msg"},{"t":"delete","p":"txpayload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":2180,"wires":[["63ac3516.b904dc"]]},{"id":"d3d1aca8.e839b","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1030,"y":2320,"wires":[]},{"id":"35fb934c.ce952c","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/+ arranged","links":["5526e934.5ca008"],"x":995,"y":2280,"wires":[]},{"id":"d85e0c7d.1022f","type":"comment","z":"abe36278.d3a5e","name":"generate unix time in ms","info":"","x":790,"y":2140,"wires":[]},{"id":"30fc15bb.82fcba","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/temperature/100100200","payload":"111","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":200,"y":80,"wires":[["26268a1e.5064b6"]]},{"id":"63ac3516.b904dc","type":"template","z":"abe36278.d3a5e","name":"sign adding","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"{{sign}}{{topic}}","output":"str","x":570,"y":2180,"wires":[["158e8008.90965"]]},{"id":"75f1ac4d.cd58f4","type":"moment","z":"abe36278.d3a5e","name":"","topic":"","input":"timeunix","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"2","adjType":"hours","adjDir":"add","format":"","locale":"de_DE","output":"timehr","outputType":"msg","outTz":"Europe/Berlin","x":780,"y":2280,"wires":[["35fb934c.ce952c","d3d1aca8.e839b"]]},{"id":"158e8008.90965","type":"moment","z":"abe36278.d3a5e","name":"","topic":"","input":"","inputType":"date","inTz":"Europe/Berlin","adjAmount":0,"adjType":"days","adjDir":"add","format":"unix","locale":"de_DE","output":"timeunix","outputType":"msg","outTz":"Europe/Berlin","x":780,"y":2180,"wires":[["c638674c.c8be08"]]},{"id":"c638674c.c8be08","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"change","p":"timeunix","pt":"msg","from":"uni","fromt":"str","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":340,"y":2280,"wires":[["75f1ac4d.cd58f4"]]},{"id":"62588364.79c2fc","type":"comment","z":"abe36278.d3a5e","name":"generate human readable time","info":"","x":810,"y":2240,"wires":[]},{"id":"1d369173.8f184f","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":200,"wires":[]},{"id":"c6327d72.f26f2","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/humidity/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":240,"wires":[["7d86554d.88239c"]]},{"id":"7d86554d.88239c","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/humidity/','');\nmsg.sign=\"H_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":240,"wires":[["1d369173.8f184f","587c45c8.37e42c"]]},{"id":"587c45c8.37e42c","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/humidity","links":["f50b416e.1fdee"],"x":695,"y":240,"wires":[]},{"id":"19ee7679.0ef9ba","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/humidity/100100201","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":200,"wires":[["7d86554d.88239c"]]},{"id":"954ac5aa.1c62e8","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":320,"wires":[]},{"id":"b32fa67f.637808","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/pressure/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":360,"wires":[["bf00f333.0c07"]]},{"id":"bf00f333.0c07","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/pressure/','');\nmsg.sign=\"P_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":360,"wires":[["954ac5aa.1c62e8","2281005e.3a255"]]},{"id":"2281005e.3a255","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/pressure","links":["f50b416e.1fdee"],"x":695,"y":360,"wires":[]},{"id":"dffd2485.193518","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/pressure/100100202","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":320,"wires":[["bf00f333.0c07"]]},{"id":"960ae0d7.576a2","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":440,"wires":[]},{"id":"5cb83c2b.430104","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/motion/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":480,"wires":[["8129f497.b57048"]]},{"id":"8129f497.b57048","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/motion/','');\nmsg.sign=\"M_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":480,"wires":[["960ae0d7.576a2","d9939c08.2ae11"]]},{"id":"d9939c08.2ae11","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/motion","links":["f50b416e.1fdee"],"x":695,"y":480,"wires":[]},{"id":"d08f3d10.9a648","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/motion/100100203","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":440,"wires":[["8129f497.b57048"]]},{"id":"9673a93f.47a588","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":560,"wires":[]},{"id":"7db06a77.1c0994","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/button/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":600,"wires":[["65bc7dc.2a87084"]]},{"id":"65bc7dc.2a87084","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/button/','');\nmsg.sign=\"B_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":600,"wires":[["9673a93f.47a588","2346d2b2.373efe"]]},{"id":"2346d2b2.373efe","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/button","links":["f50b416e.1fdee"],"x":695,"y":600,"wires":[]},{"id":"bda69531.b97f18","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/button/100100204","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":560,"wires":[["65bc7dc.2a87084"]]},{"id":"50ab3d9d.45bf44","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":680,"wires":[]},{"id":"8991dc.08162e28","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/luminous/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":720,"wires":[["eac71975.e07328"]]},{"id":"eac71975.e07328","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/luminous/','');\nmsg.sign=\"L_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":720,"wires":[["50ab3d9d.45bf44","a68fa099.dc2ab"]]},{"id":"a68fa099.dc2ab","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/luminous","links":["f50b416e.1fdee"],"x":695,"y":720,"wires":[]},{"id":"856c9392.c2ac5","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/luminous/100100205","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":680,"wires":[["eac71975.e07328"]]},{"id":"bbeb5730.550078","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":800,"wires":[]},{"id":"8fa7fb62.b09958","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/distance/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":150,"y":840,"wires":[["f6d98985.33a618"]]},{"id":"f6d98985.33a618","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/distance/','');\nmsg.sign=\"D_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":840,"wires":[["bbeb5730.550078","d35f7954.6f0ee8"]]},{"id":"d35f7954.6f0ee8","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/distance","links":["f50b416e.1fdee"],"x":695,"y":840,"wires":[]},{"id":"bc68c5d.7516638","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/distanz/100100206","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":800,"wires":[["f6d98985.33a618"]]},{"id":"c4238039.b00f7","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":920,"wires":[]},{"id":"548f8537.814d9c","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/CO2/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":960,"wires":[["68d992d.3d1b26c"]]},{"id":"68d992d.3d1b26c","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/CO2/','');\nmsg.sign=\"C_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":960,"wires":[["c4238039.b00f7","701fba44.cafef4"]]},{"id":"701fba44.cafef4","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/CO2","links":["f50b416e.1fdee"],"x":695,"y":960,"wires":[]},{"id":"fd793b17.d8cd18","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/CO2/100100207","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":920,"wires":[["68d992d.3d1b26c"]]},{"id":"13b43b3e.924585","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1040,"wires":[]},{"id":"19cf3dee.eac602","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/VOC/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1080,"wires":[["8f26806.09e568"]]},{"id":"8f26806.09e568","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/VOC/','');\nmsg.sign=\"V_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1080,"wires":[["13b43b3e.924585","7f922cdd.df5124"]]},{"id":"7f922cdd.df5124","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/VOC","links":["f50b416e.1fdee"],"x":695,"y":1080,"wires":[]},{"id":"d0533d4e.96313","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/VOC/100100208","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1040,"wires":[["8f26806.09e568"]]},{"id":"63873e40.930f8","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1160,"wires":[]},{"id":"d943c2f6.450ef","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/gyro/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1200,"wires":[["f917dc87.ade25"]]},{"id":"f917dc87.ade25","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/gyro/','');\nmsg.sign=\"G_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1200,"wires":[["63873e40.930f8","44b7b8ca.82b598"]]},{"id":"44b7b8ca.82b598","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/gyro","links":["f50b416e.1fdee"],"x":695,"y":1200,"wires":[]},{"id":"478aa5f5.0db44c","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/gyro/100100209","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1160,"wires":[["f917dc87.ade25"]]},{"id":"b14fcd65.3453d","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1280,"wires":[]},{"id":"54619345.f49f9c","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/acceleration/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":160,"y":1320,"wires":[["5265676f.443228"]]},{"id":"5265676f.443228","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/acceleration/','');\nmsg.sign=\"A_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1320,"wires":[["b14fcd65.3453d","e2d2dfc9.c97f"]]},{"id":"e2d2dfc9.c97f","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/acceleration","links":["f50b416e.1fdee"],"x":695,"y":1320,"wires":[]},{"id":"3d02e91c.2d10c6","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/acceleration/100100210","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":110,"y":1280,"wires":[["5265676f.443228"]]},{"id":"f43d2857.e6a598","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1400,"wires":[]},{"id":"286f43c3.795d0c","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/UV/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":130,"y":1440,"wires":[["50539718.b2d1b8"]]},{"id":"50539718.b2d1b8","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/UV/','');\nmsg.sign=\"U_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1440,"wires":[["f43d2857.e6a598","38c79a82.be1d06"]]},{"id":"38c79a82.be1d06","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/UV","links":["f50b416e.1fdee"],"x":695,"y":1440,"wires":[]},{"id":"ead4dd04.96f4d","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/UV/100100211","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1400,"wires":[["50539718.b2d1b8"]]},{"id":"d7ef4e0c.20d22","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1520,"wires":[]},{"id":"d4dd49d3.f8ab98","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/E-field/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1560,"wires":[["40b85687.d3e988"]]},{"id":"40b85687.d3e988","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/E-field/','');\nmsg.sign=\"E_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1560,"wires":[["d7ef4e0c.20d22","cf4416b6.734368"]]},{"id":"cf4416b6.734368","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/e-field","links":["f50b416e.1fdee"],"x":695,"y":1560,"wires":[]},{"id":"13c4a939.5d98d7","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/E-field/100100212","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":190,"y":1520,"wires":[["40b85687.d3e988"]]},{"id":"7d651b44.4e2ff4","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1640,"wires":[]},{"id":"e2650f19.a6af4","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/wind/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1680,"wires":[["93414218.eef2b"]]},{"id":"93414218.eef2b","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/wind/','');\nmsg.sign=\"W_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1680,"wires":[["7d651b44.4e2ff4","9c8723db.aa25b"]]},{"id":"9c8723db.aa25b","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/wind","links":["f50b416e.1fdee"],"x":695,"y":1680,"wires":[]},{"id":"3a0c20.f89a23e","type":"inject","z":"abe36278.d3a5e","name":"","topic":"sensors/wind/100100213","payload":"213","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":180,"y":1640,"wires":[["93414218.eef2b"]]},{"id":"ea00faed.9135e8","type":"inject","z":"abe36278.d3a5e","name":"","topic":"100100200/LED","payload":"1","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":130,"y":2640,"wires":[["c14fe536.1d0538"]]},{"id":"b1a018b7.8396a8","type":"mqtt out","z":"abe36278.d3a5e","name":"actuator output","topic":"","qos":"2","retain":"","broker":"3bd1ba7.f516946","x":1060,"y":2640,"wires":[]},{"id":"c14fe536.1d0538","type":"template","z":"abe36278.d3a5e","name":"set MQTT topic actuators/","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"actuators/{{topic}}","output":"str","x":350,"y":2640,"wires":[["b1a018b7.8396a8"]]},{"id":"92a479c5.04d388","type":"comment","z":"abe36278.d3a5e","name":"generate time values ","info":"","x":130,"y":2120,"wires":[]},{"id":"11c2a485.40609b","type":"comment","z":"abe36278.d3a5e","name":"listen on all possible sensor topics","info":"","x":160,"y":20,"wires":[]},{"id":"9d7d983c.988bf8","type":"comment","z":"abe36278.d3a5e","name":"Disconnect-Watchdog","info":"","x":120,"y":2760,"wires":[]},{"id":"c8282c89.66846","type":"inject","z":"abe36278.d3a5e","name":"20s Clock","topic":"","payload":"","payloadType":"date","repeat":"20","crontab":"","once":true,"onceDelay":0.1,"x":150,"y":2820,"wires":[["c152e79f.413c98"]]},{"id":"71ac024a.818cbc","type":"template","z":"abe36278.d3a5e","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":2820,"wires":[["556cffda.7bae8"]]},{"id":"556cffda.7bae8","type":"sqlite","z":"abe36278.d3a5e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2820,"wires":[["5bbf58ff.a3aed8"]]},{"id":"5bbf58ff.a3aed8","type":"function","z":"abe36278.d3a5e","name":"set timeout if needed","func":"msg.payload.forEach(function(element, index) {\n    var backupStatus = element.status;\n    if (element.lastmsgtime < (msg.time - 2*element.curinterval*1000)) {\n        // last msg not received in time, timeout required\n        element.status = \"disconnected\";\n    }\n    else {\n        element.status = \"connected\";\n    }\n    \n    var hasChangedStatus = false;\n    if (element.status != backupStatus) {\n        hasChangedStatus = true;\n    }\n    \n    node.send({\n        payload: element.status,\n        refid: element.refid,\n        changedStatus: hasChangedStatus\n    });\n});","outputs":1,"noerr":0,"x":1040,"y":2820,"wires":[["74cdd7dc.cb7e18"]]},{"id":"c152e79f.413c98","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"set","p":"time","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":2820,"wires":[["71ac024a.818cbc","5e18ecc4.790714"]]},{"id":"74cdd7dc.cb7e18","type":"template","z":"abe36278.d3a5e","name":"update status","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set status = '{{payload}}' where refid = {{refid}};","output":"str","x":600,"y":2880,"wires":[["a6279627.cbd1c8"]]},{"id":"a6279627.cbd1c8","type":"sqlite","z":"abe36278.d3a5e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2880,"wires":[["1b19830.1cae57d"]]},{"id":"b0192ac6.35eb98","type":"link out","z":"abe36278.d3a5e","name":"OUT timeout","links":["3c4244a8.5e3bfc","583d15e0.008b1c","6cc07fa0.498d6"],"x":1215,"y":2880,"wires":[]},{"id":"1b19830.1cae57d","type":"function","z":"abe36278.d3a5e","name":"check if status changed","func":"if (msg.changedStatus) {\n    return msg;\n}","outputs":1,"noerr":0,"x":1050,"y":2880,"wires":[["b0192ac6.35eb98","3e42fb20.95df44"]]},{"id":"3e42fb20.95df44","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1250,"y":2920,"wires":[]},{"id":"5e18ecc4.790714","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":330,"y":2880,"wires":[]},{"id":"1ff60300.38542d","type":"mqtt out","z":"abe36278.d3a5e","name":"curinvervall output","topic":"","qos":"2","retain":"","broker":"3bd1ba7.f516946","x":1070,"y":2480,"wires":[]},{"id":"4de888b.5badf78","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1030,"y":2440,"wires":[]},{"id":"c5e78dbd.d82d2","type":"template","z":"abe36278.d3a5e","name":"add config/interval/","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"config/interval/{{topic}}","output":"str","x":330,"y":2480,"wires":[["7112c651.6320c8"]]},{"id":"9c9f7ebb.af96c","type":"link in","z":"abe36278.d3a5e","name":"IN curinterval","links":["9428743c.a07ce8"],"x":175,"y":2480,"wires":[["c5e78dbd.d82d2"]]},{"id":"7112c651.6320c8","type":"change","z":"abe36278.d3a5e","name":"","rules":[{"t":"change","p":"topic","pt":"msg","from":"&#x2F;","fromt":"str","to":"/","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":590,"y":2480,"wires":[["1ff60300.38542d","4de888b.5badf78"]]},{"id":"ddf79d08.4357f","type":"template","z":"9648297c.564688","name":"select * where refId matching","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT * FROM connections WHERE refid = {{payload}};","output":"str","x":600,"y":540,"wires":[["7d68ce83.5698b"]]},{"id":"9ff68857.8fc508","type":"comment","z":"9648297c.564688","name":"Read specific id from connections table","info":"","x":170,"y":480,"wires":[]},{"id":"f50b416e.1fdee","type":"link in","z":"9648297c.564688","name":"IN select * where refid matching","links":["2281005e.3a255","2346d2b2.373efe","38c79a82.be1d06","44b7b8ca.82b598","587c45c8.37e42c","701fba44.cafef4","7f922cdd.df5124","9c8723db.aa25b","a0a4ea84.688238","a68fa099.dc2ab","b045af00.49371","cf4416b6.734368","d35f7954.6f0ee8","d9939c08.2ae11","e2d2dfc9.c97f"],"x":175,"y":540,"wires":[["ddf79d08.4357f"]]},{"id":"7d4be22f.eef0bc","type":"link out","z":"9648297c.564688","name":"OUT select * where refid matching","links":["c7a7d482.844708"],"x":1015,"y":540,"wires":[]},{"id":"7f63efee.c6ad3","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":580,"wires":[]},{"id":"a5da5550.3ed8a8","type":"comment","z":"9648297c.564688","name":"Write new value into <sign>_<refid> table","info":"","x":180,"y":660,"wires":[]},{"id":"69243967.d2b928","type":"template","z":"9648297c.564688","name":"insert into <sign>_<refId>","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"INSERT INTO {{topic}}(timehr,timeunix, value) VALUES('{{timehr}}',{{timeunix}}, {{payload}});","output":"str","x":590,"y":780,"wires":[["fe1f6bac.a490d8"]]},{"id":"5526e934.5ca008","type":"link in","z":"9648297c.564688","name":"IN insert into <sign>_<refId>","links":["35fb934c.ce952c"],"x":175,"y":720,"wires":[["6a4342d6.219a3c"]]},{"id":"7d68ce83.5698b","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":540,"wires":[["7f63efee.c6ad3","7d4be22f.eef0bc"]]},{"id":"fe1f6bac.a490d8","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT * FROM T_100100200;","name":"","x":870,"y":780,"wires":[["64e0c8fb.934478"]]},{"id":"5f21bbb9.4d9c64","type":"template","z":"9648297c.564688","name":"Create Table IF NOT EXISTS","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"CREATE TABLE IF NOT EXISTS {{topic}}(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);","output":"str","x":600,"y":720,"wires":[["5fa717fd.d387a8"]]},{"id":"5fa717fd.d387a8","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT * FROM T_100100200;","name":"","x":870,"y":720,"wires":[["2bcc2e3d.24f7c2"]]},{"id":"6a4342d6.219a3c","type":"change","z":"9648297c.564688","name":"back up topic and payload","rules":[{"t":"move","p":"topic","pt":"msg","to":"toptmp","tot":"msg"},{"t":"set","p":"topic","pt":"msg","to":"toptmp","tot":"msg"},{"t":"move","p":"payload","pt":"msg","to":"payltmp","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"payltmp","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":330,"y":720,"wires":[["5f21bbb9.4d9c64","bdb7cff8.b34fe"]]},{"id":"2bcc2e3d.24f7c2","type":"change","z":"9648297c.564688","name":"retrieve original topic and payload","rules":[{"t":"move","p":"toptmp","pt":"msg","to":"topic","tot":"msg"},{"t":"delete","p":"toptmp","pt":"msg"},{"t":"move","p":"payltmp","pt":"msg","to":"payload","tot":"msg"},{"t":"delete","p":"payltmp","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":780,"wires":[["69243967.d2b928"]]},{"id":"bdb7cff8.b34fe","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":680,"wires":[]},{"id":"c1cb84af.9e9168","type":"link out","z":"9648297c.564688","name":"OUT insert into <sign>_<refid>","links":["3c4244a8.5e3bfc","583d15e0.008b1c","6cc07fa0.498d6"],"x":1015,"y":840,"wires":[]},{"id":"64e0c8fb.934478","type":"template","z":"9648297c.564688","name":"update lastmsgtime","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set lastmsgtime = {{timeunix}} where refid = {{clientinfo.refid}};","output":"str","x":570,"y":840,"wires":[["43ee39c8.d4eca8"]]},{"id":"c302cf81.150ed","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":880,"wires":[]},{"id":"43ee39c8.d4eca8","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT * FROM T_100100200;","name":"","x":870,"y":840,"wires":[["c302cf81.150ed","c1cb84af.9e9168"]]},{"id":"15fddf2b.0cd421","type":"comment","z":"9648297c.564688","name":"DEVICESETTINGS Change connections table / save settings","info":"","x":220,"y":900,"wires":[]},{"id":"bc5949d4.d8af28","type":"link in","z":"9648297c.564688","name":"IN change connections table","links":["f2bdfc37.23df3"],"x":175,"y":1160,"wires":[["a48f1067.148a6"]]},{"id":"d226c6f7.31e318","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1290,"y":1000,"wires":[]},{"id":"6f1f439a.00cddc","type":"function","z":"9648297c.564688","name":"","func":"msg.deviceId=msg.payload.deviceId;\nmsg.dispName=msg.payload.dispName;\nmsg.isVisible=msg.payload.isVisible;\nmsg.shownDataPoints=msg.payload.shownDataPoints;\nmsg.interval=msg.payload.interval;\n\nreturn msg;","outputs":1,"noerr":0,"x":390,"y":980,"wires":[["4519fba7.92cb74"]]},{"id":"9428743c.a07ce8","type":"link out","z":"9648297c.564688","name":"OUT curinterval","links":["9c9f7ebb.af96c"],"x":1215,"y":1040,"wires":[]},{"id":"68094d4a.24aab4","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"deviceoverview","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.html","format":"text","x":800,"y":1320,"wires":[[],["30383508.2eee2a"]]},{"id":"b5824467.7f2d18","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"devicesettings","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.js","format":"javascript","x":800,"y":1800,"wires":[["7f67709f.2a7ad","f2bdfc37.23df3"],["b81d2bb.eb2a4d8"]]},{"id":"6c4c9364.239cac","type":"link out","z":"64c3c505.631b7c","name":"OUT dashboard ctrl","links":["8522f4ba.537b88"],"x":955,"y":440,"wires":[]},{"id":"8522f4ba.537b88","type":"link in","z":"64c3c505.631b7c","name":"IN dashboard ctrl","links":["6c4c9364.239cac","98f475a1.c5bcb8","7c64450c.5076cc","4564be3d.06854","d64572d.f9e119"],"x":35,"y":60,"wires":[["7451e53b.0b9afc"]]},{"id":"7451e53b.0b9afc","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":60,"wires":[["7f6e7c82.f3d964"],["7f6e7c82.f3d964"],[]]},{"id":"7f6e7c82.f3d964","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"},{"t":"delete","p":"cacheControl","pt":"msg"},{"t":"delete","p":"_socketId","pt":"msg"},{"t":"delete","p":"from","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":300,"y":60,"wires":[["a490dee9.05dd8"]]},{"id":"6db1f4b2.45bddc","type":"comment","z":"64c3c505.631b7c","name":"DASHBOARD Autosending on page load","info":"ctrl messages from uibuilder node are analysed.\n\nIf page is (re)loading, the flow downwards is triggered.\n\nSee here:\nhttps://github.com/TotallyInformation/node-red-contrib-uibuilder/wiki/How-to-send-data-when-a-client-connects-or-reloads-the-page","x":180,"y":20,"wires":[]},{"id":"7b50a346.6928fc","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"dashboard","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.html","format":"text","x":790,"y":400,"wires":[["c8c7962.a4c6f68","eb76a666.673048"],["6c4c9364.239cac"]]},{"id":"55e4ed9e.021494","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":120,"wires":[["1665ed13.9d77e3"]]},{"id":"cad8a1c9.0f181","type":"template","z":"64c3c505.631b7c","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout;","output":"str","x":580,"y":120,"wires":[["55e4ed9e.021494"]]},{"id":"1665ed13.9d77e3","type":"function","z":"64c3c505.631b7c","name":"sort layout data","func":"msg.dashboardData = [];\n\nmsg.payload.forEach(function(item, index) {\n    var uiType = item.htmlid.split(\"-\")[0];\n    var measType = item.htmlid.split(\"-\")[1];\n    var deviceId = item.htmlid.split(\"-\")[2];\n    \n    msg.dashboardData.push({\n        htmlId : item.htmlid,\n        numberGroup : item.numbergroup,\n        numberItem : item.numberitem,\n        uiType : uiType,\n        measType : measType,\n        deviceId : deviceId\n    });\n\n});\n\nmsg.payload = msg.dashboardData;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":120,"wires":[["5e4a11f6.af05a"]]},{"id":"3b3f29cf.c8d766","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":180,"wires":[["34a8f31a.e0d5ec"]]},{"id":"9e73cd66.b3ca6","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":360,"wires":[]},{"id":"5e4a11f6.af05a","type":"function","z":"64c3c505.631b7c","name":"forEach send select showndatapoints where refId matching","func":"msg.dashboardData.forEach(function(e, i) {\n    var isComplete = false;\n    if (i == (msg.dashboardData.length -1)) {\n        //is last element\n        isComplete = true;\n    }\n    \n    \n    if (isComplete) {\n        node.send({\n            \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + e.deviceId.toString() + \";\",\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"index\": i,\n            \"parts\": { \"index\": i },\n            \"complete\": isComplete\n        });\n    }\n    else {\n        node.send({\n            \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + e.deviceId.toString() + \";\",\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"index\": i,\n            \"parts\": { \"index\": i }\n        });\n    }\n});\n//return msg;","outputs":1,"noerr":0,"x":260,"y":180,"wires":[["696b839c.81fc0c"]]},{"id":"93c860a8.4ff01","type":"function","z":"64c3c505.631b7c","name":"include in dashboardData","func":"//extract device id from sql query / topic\nvar deviceId = msg.topic.split(\"= \")[1].split(\";\")[0];\n\nmsg.dashboardData.forEach(function(e, i) {\n    //if (e.htmlId.includes(\"chart\") && e.htmlId.includes(deviceId)) {\n    if (e.htmlId.includes(\"chart\")) {\n        e.shownDataPoints = msg.payload[i][0].showndatapoints;\n        e.dispName = msg.payload[i][0].dispname;\n        e.deviceStatus = msg.payload[i][0].status;\n    }\n    //else if(e.htmlId.includes(deviceId)) {\n    else {\n        e.dispName = msg.payload[i][0].dispname;\n        e.deviceStatus = msg.payload[i][0].status;\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":180,"wires":[["577e8360.19782c"]]},{"id":"6e274d47.dc8e94","type":"function","z":"64c3c505.631b7c","name":"forEach send select datapoints","func":"msg.dashboardData.forEach(function(e, i) {\n    var tempTopic = \"\";\n\n    if (e.htmlId.includes(\"chart\") && typeof e.shownDataPoints !== 'undefined') {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Ana\")) {\n            tempTopic = \"select * from O_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n\n        \n        var isComplete = false;\n        if (i == (msg.dashboardData.length -1)) {\n            //is last element\n            isComplete = true;\n        }\n        \n        if (isComplete) {\n            node.send({\n                \"topic\": tempTopic,\n                \"curItem\": e.htmlId,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i },\n                \"complete\": isComplete\n            });\n        }\n        else {\n            node.send({\n                \"topic\": tempTopic,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i }\n            });\n        }\n    }\n    else if (e.htmlId.includes(\"val\")) {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Ana\")) {\n            tempTopic = \"select * from O_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        \n\n        var isComplete = false;\n        if (i == (msg.dashboardData.length -1)) {\n            //is last element\n            isComplete = true;\n        }\n        \n        if (isComplete) {\n            node.send({\n                \"topic\": tempTopic,\n                \"curItem\": e.htmlId,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i },\n                \"complete\": isComplete\n            });\n        }\n        else {\n            node.send({\n                \"topic\": tempTopic,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i }\n            });\n        }\n    }\n});\n\n//return msg;","outputs":1,"noerr":0,"x":350,"y":300,"wires":[["1b3b332a.bf2d6d"]]},{"id":"5922bf4a.42b5c","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":300,"wires":[["bf2ddf0d.16ef7"]]},{"id":"182cae5f.3a62d2","type":"function","z":"64c3c505.631b7c","name":"include DataPoints in dashboardData","func":"var setLastItem = false;\n\nmsg.dashboardData.forEach(function(e, i) {\n    //reverse data from db and save in dashboardData object\n    e.DataPoints = msg.payload[i].reverse();\n    \n    \n    //check if this element is the last possible match\n    if (i == (msg.dashboardData.length -1)) {\n        setLastItem = true;\n    }\n});\n\nmsg.topic = \"onLoadData\";\n\nif (setLastItem) {\n    msg.payload = \"lastItem\";\n    return msg;\n}\nelse {\n    msg.payload = \"\";\n}\n","outputs":1,"noerr":0,"x":530,"y":360,"wires":[["9e73cd66.b3ca6","7b50a346.6928fc"]]},{"id":"74462a6b.1bf1c4","type":"template","z":"64c3c505.631b7c","name":"select * from uigroups","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uigroups;","output":"str","x":580,"y":60,"wires":[["49fbac4b.d840f4"]]},{"id":"49fbac4b.d840f4","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":60,"wires":[["fa6c538f.a92a7"]]},{"id":"fa6c538f.a92a7","type":"function","z":"64c3c505.631b7c","name":"sort group data","func":"msg.dashboardGroups = [];\n\nmsg.payload.forEach(function(item, index) {\n    var itemList = [];\n    \n    item.items.split('').forEach(function(element) {\n        if (element == \"V\") itemList.push(\"value\")\n        else if (element == \"C\") itemList.push(\"chart\")\n    });\n    \n    \n    \n    msg.dashboardGroups.push({\n        htmlId : item.htmlid,\n        name: item.name,\n        items: itemList\n    });\n\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":60,"wires":[["cad8a1c9.0f181"]]},{"id":"30383508.2eee2a","type":"link out","z":"64c3c505.631b7c","name":"OUT deviceoverview ctrl","links":["b92ff6e7.3eba98"],"x":955,"y":1360,"wires":[]},{"id":"b92ff6e7.3eba98","type":"link in","z":"64c3c505.631b7c","name":"IN deviceoverview ctrl","links":["30383508.2eee2a"],"x":35,"y":1240,"wires":[["fe33ceee.4a5f8"]]},{"id":"fe33ceee.4a5f8","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":1240,"wires":[["239b30c9.eabbb"],["239b30c9.eabbb"],[]]},{"id":"239b30c9.eabbb","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":1240,"wires":[["bceeeac2.d00588"]]},{"id":"bceeeac2.d00588","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1240,"wires":[["c581e1df.f0be2"]]},{"id":"96b43e13.eca2d","type":"comment","z":"64c3c505.631b7c","name":"DEVICEOVERVIEW Autosending on page load","info":"","x":200,"y":1200,"wires":[]},{"id":"c581e1df.f0be2","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1240,"wires":[["4d10583c.fe4c58"]]},{"id":"4d10583c.fe4c58","type":"function","z":"64c3c505.631b7c","name":"sort overviewData","func":"msg.overviewData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.overviewData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\nmsg.topic = \"onLoadData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1240,"wires":[["68094d4a.24aab4","f144d6f3.b911b8"]]},{"id":"f144d6f3.b911b8","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":1300,"wires":[]},{"id":"c8c7962.a4c6f68","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1010,"y":400,"wires":[]},{"id":"ae4b9d41.25f9f","type":"comment","z":"64c3c505.631b7c","name":"DASHBOARD Send new data / Update","info":"","x":170,"y":460,"wires":[]},{"id":"f8b132a8.b5bf6","type":"comment","z":"64c3c505.631b7c","name":"DEVICEOVERVIEW Send new data / Update","info":"","x":190,"y":1400,"wires":[]},{"id":"b81d2bb.eb2a4d8","type":"link out","z":"64c3c505.631b7c","name":"OUT devicesettings ctrl","links":["2d8aefbe.47617"],"x":955,"y":1840,"wires":[]},{"id":"2d8aefbe.47617","type":"link in","z":"64c3c505.631b7c","name":"In devicesettings ctrl","links":["b81d2bb.eb2a4d8"],"x":35,"y":1640,"wires":[["e5a95187.5f55c"]]},{"id":"e5a95187.5f55c","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":1640,"wires":[["523c3d34.ed9204"],["523c3d34.ed9204"],[]]},{"id":"523c3d34.ed9204","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":1640,"wires":[["e516db3d.8fac88","9e1ad9ff.78a248"]]},{"id":"2bcdf339.85baac","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1640,"wires":[["5c1b104c.79aa5"]]},{"id":"5c1b104c.79aa5","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1640,"wires":[["a572ffa5.a2db5"]]},{"id":"a572ffa5.a2db5","type":"function","z":"64c3c505.631b7c","name":"sort settingsInputData, forEach send lastmsgtime","func":"var settingsInputData = [];\n\nmsg.payload.forEach(function(e,i) {\n    settingsInputData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status,\n        interval: e.curinterval,\n        units: e.curunit,\n        shownDataPoints: e.showndatapoints,\n        isNotifying: e.isnotifying,\n        lastReceivedVal: e.lastmsgtime,\n        manControl: e.mancontrol,\n        linkedTo: e.linkedto,\n        threshold: e.threshold,\n        linkRule: e.linkrule,\n        linkedMeas: e.linkedMeas\n    });\n    \n    node.send({\n        payload: e.lastmsgtime,\n        topic: e.refid,\n        settingsInputData: settingsInputData,\n        dataLength: msg.payload.length\n    });\n});\n","outputs":1,"noerr":0,"x":1130,"y":1640,"wires":[["142355db.8169fa"]]},{"id":"142355db.8169fa","type":"moment","z":"64c3c505.631b7c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"0","adjType":"hours","adjDir":"add","format":"fromNow","locale":"en_EN","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":800,"y":1700,"wires":[["18c8d62.b972d2a"]]},{"id":"18c8d62.b972d2a","type":"function","z":"64c3c505.631b7c","name":"attach formatted lastmsgtime","func":"\nmsg.settingsInputData.forEach(function(element, index) {\n    if (element.deviceId == msg.topic) {\n        element.lastReceivedVal = msg.payload;\n    }\n});\n\nmsg.topic = \"onLoadData\";\n\nif (msg.settingsInputData.length == msg.dataLength) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":1700,"wires":[["b5824467.7f2d18","dc7c7863.a247d8"]]},{"id":"dc7c7863.a247d8","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":1700,"wires":[]},{"id":"7f67709f.2a7ad","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":990,"y":1800,"wires":[]},{"id":"6cc07fa0.498d6","type":"link in","z":"64c3c505.631b7c","name":"IN dataUpdate dashboard","links":["b0192ac6.35eb98","c1cb84af.9e9168"],"x":155,"y":540,"wires":[["a6936b2.b1c0a98"]]},{"id":"537eec82.6055a4","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1310,"y":700,"wires":[]},{"id":"72e7289b.406168","type":"template","z":"64c3c505.631b7c","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout where htmlid in ('val-{{payload}}-{{clientinfo.refid}}','chart-{{payload}}-{{clientinfo.refid}}') ;","output":"str","x":580,"y":500,"wires":[["a4650d0c.554e7"]]},{"id":"a4650d0c.554e7","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":540,"wires":[["93ddec8b.2b66f"]]},{"id":"93ddec8b.2b66f","type":"function","z":"64c3c505.631b7c","name":"sort layout data","func":"msg.dashboardData = [];\n\nmsg.payload.forEach(function(item, index) {\n    var uiType = item.htmlid.split(\"-\")[0];\n    var measType = item.htmlid.split(\"-\")[1];\n    var deviceId = item.htmlid.split(\"-\")[2];\n    \n    msg.dashboardData.push({\n        htmlId : item.htmlid,\n        numberGroup : item.numbergroup,\n        numberItem : item.numberitem,\n        uiType : uiType,\n        measType : measType,\n        deviceId : deviceId\n    });\n\n});\n\nmsg.payload = msg.dashboardData;\n\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":540,"wires":[["23d3e229.b25cbe"]]},{"id":"23d3e229.b25cbe","type":"function","z":"64c3c505.631b7c","name":"forEach send select showndatapoints where refId matching","func":"msg.dashboardData.forEach(function(e, i) {\n    var isComplete = false;\n    if (i == (msg.dashboardData.length -1)) {\n        //is last element\n        isComplete = true;\n    }\n    \n    \n    if (isComplete) {\n        node.send({\n            \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + e.deviceId.toString() + \";\",\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"index\": i,\n            \"parts\": { \"index\": i },\n            \"complete\": isComplete\n        });\n    }\n    else {\n        node.send({\n            \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + e.deviceId.toString() + \";\",\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"index\": i,\n            \"parts\": { \"index\": i }\n        });\n    }\n});\n//return msg;","outputs":1,"noerr":0,"x":260,"y":600,"wires":[["e4e9df54.ff6d3"]]},{"id":"63ebbba8.67ee54","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":600,"wires":[["b67c22f6.3ce91"]]},{"id":"e962d952.cbded8","type":"function","z":"64c3c505.631b7c","name":"include in dashboardData","func":"//extract device id from sql query / topic\nvar deviceId = msg.topic.split(\"= \")[1].split(\";\")[0];\n\nmsg.dashboardData.forEach(function(e, i) {\n    //if (e.htmlId.includes(\"chart\") && e.htmlId.includes(deviceId)) {\n    if (e.htmlId.includes(\"chart\")) {\n        e.shownDataPoints = msg.payload[i][0].showndatapoints;\n        e.dispName = msg.payload[i][0].dispname;\n        e.deviceStatus = msg.payload[i][0].status;\n    }\n    //else if(e.htmlId.includes(deviceId)) {\n    else {\n        e.dispName = msg.payload[i][0].dispname;\n        e.deviceStatus = msg.payload[i][0].status;\n    }\n});\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":600,"wires":[["2725cb42.5af854"]]},{"id":"f6a4f0b5.1db4","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":660,"wires":[["1bb9dbb5.1d1474"]]},{"id":"9557844d.e9a5c8","type":"function","z":"64c3c505.631b7c","name":"include in dashboardData","func":"var setLastItem = false;\n\nmsg.dashboardData.forEach(function(e, i) {\n    //reverse data from db and save in dashboardData object\n    e.DataPoints = msg.payload[i].reverse();\n    \n    \n    //check if this element is the last possible match\n    if (i == (msg.dashboardData.length -1)) {\n        setLastItem = true;\n    }\n});\n\nif (setLastItem) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\nmsg.topic = \"updateData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1190,"y":660,"wires":[["c484dc3e.6133","537eec82.6055a4"]]},{"id":"4ec1ee5b.1695","type":"function","z":"64c3c505.631b7c","name":"set measurement type","func":"switch(msg.sign) {\n    case 'T_':\n        msg.payload = 'Temp';\n        break;\n    case 'H_':\n        msg.payload = 'Hum';\n        break;\n    case 'P_':\n        msg.payload = 'Press';\n        break;\n    case 'M_':\n        msg.payload = 'Mot';\n        break;\n    case 'B_':\n        msg.payload = 'But';\n        break;\n    case 'L_':\n        msg.payload = 'Lum';\n        break;\n    case 'D_':\n        msg.payload = 'Dist';\n        break;\n    case 'C_':\n        msg.payload = 'Co2';\n        break;\n    case 'V_':\n        msg.payload = 'Voc';\n        break;\n    case 'G_':\n        msg.payload = 'Gyro';\n        break;\n    case 'A_':\n        msg.payload = 'Acc';\n        break;\n    case 'U_':\n        msg.payload = 'Uv';\n        break;\n    case 'E_':\n        msg.payload = 'Efi';\n        break;\n    case 'W_':\n        msg.payload = 'Wind';\n        break;\n    case 'O_':\n        msg.payload = 'Ana';\n        break;\n    default: \n        break;\n}\nreturn msg;","outputs":1,"noerr":0,"x":340,"y":500,"wires":[["72e7289b.406168"]]},{"id":"c484dc3e.6133","type":"link out","z":"64c3c505.631b7c","name":"OUT dataUpdate dashboard","links":["4ebd018a.a230f"],"x":1355,"y":660,"wires":[]},{"id":"4ebd018a.a230f","type":"link in","z":"64c3c505.631b7c","name":"IN dashboard","links":["929b49fc.6b88f8","c484dc3e.6133"],"x":655,"y":440,"wires":[["7b50a346.6928fc"]]},{"id":"5fe6fbac.5edf24","type":"link in","z":"64c3c505.631b7c","name":"IN discoveryUpdate deviceoverview","links":["3c1c50e0.9d134"],"x":155,"y":1440,"wires":[["d681efbf.79a93"]]},{"id":"188d5e14.94cbb2","type":"link in","z":"64c3c505.631b7c","name":"IN discoveryUpdate dashboard","links":["3c1c50e0.9d134","e3d1eb5a.5d6a08"],"x":155,"y":740,"wires":[["4beb8cb2.cc0d64"]]},{"id":"11a4a0ae.8ca89f","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1150,"y":1380,"wires":[]},{"id":"d681efbf.79a93","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1440,"wires":[["42e98f0c.565de"]]},{"id":"42e98f0c.565de","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1440,"wires":[["37e14947.dae656"]]},{"id":"37e14947.dae656","type":"function","z":"64c3c505.631b7c","name":"sort overviewData","func":"msg.overviewData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.overviewData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\nmsg.topic = \"discoveryData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1440,"wires":[["68094d4a.24aab4","11a4a0ae.8ca89f"]]},{"id":"16c3e4c8.7f6c1b","type":"comment","z":"64c3c505.631b7c","name":"DEVICESETTINGS Autosending on page load","info":"","x":190,"y":1600,"wires":[]},{"id":"80c9bf44.553ae","type":"comment","z":"64c3c505.631b7c","name":"DEVICESETTINGS Send new data / Update","info":"","x":190,"y":1900,"wires":[]},{"id":"37589543.6db32a","type":"link in","z":"64c3c505.631b7c","name":"IN discoveryUpdate devicesettings","links":["3c1c50e0.9d134"],"x":155,"y":1940,"wires":[["776afa30.a72f14"]]},{"id":"583d15e0.008b1c","type":"link in","z":"64c3c505.631b7c","name":"IN dataUpdate devicesettings","links":["b0192ac6.35eb98","c1cb84af.9e9168","ea7fbf74.48f2e"],"x":155,"y":2080,"wires":[["709c1c11.3cd624"]]},{"id":"776afa30.a72f14","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1940,"wires":[["a7de5dcb.4f99b"]]},{"id":"a7de5dcb.4f99b","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1940,"wires":[["38c19c80.2cf964"]]},{"id":"38c19c80.2cf964","type":"function","z":"64c3c505.631b7c","name":"sort settingsInputData, forEach send lastmsgtime","func":"var settingsInputData = [];\n\nmsg.payload.forEach(function(e,i) {\n    settingsInputData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status,\n        interval: e.curinterval,\n        units: e.curunit,\n        shownDataPoints: e.showndatapoints,\n        isNotifying: e.isnotifying,\n        lastReceivedVal: e.lastmsgtime,\n        manControl: e.mancontrol,\n        linkedTo: e.linkedto,\n        threshold: e.threshold,\n        linkRule: e.linkrule,\n        linkedMeas: e.linkedMeas\n    });\n    \n    node.send({\n        payload: e.lastmsgtime,\n        topic: e.refid,\n        settingsInputData: settingsInputData,\n        dataLength: msg.payload.length\n    });\n});\n","outputs":1,"noerr":0,"x":1130,"y":1940,"wires":[["863512f.f15adf"]]},{"id":"863512f.f15adf","type":"moment","z":"64c3c505.631b7c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"0","adjType":"hours","adjDir":"add","format":"fromNow","locale":"en_EN","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":800,"y":2000,"wires":[["b117fd03.b938"]]},{"id":"b117fd03.b938","type":"function","z":"64c3c505.631b7c","name":"attach formatted lastmsgtime","func":"\nmsg.settingsInputData.forEach(function(element, index) {\n    if (element.deviceId == msg.topic) {\n        element.lastReceivedVal = msg.payload;\n    }\n});\n\nmsg.topic = \"discoveryData\";\n\nif (msg.settingsInputData.length == msg.dataLength) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":2000,"wires":[["ccd0d6eb.7b7bc8"]]},{"id":"ccd0d6eb.7b7bc8","type":"link out","z":"64c3c505.631b7c","name":"OUT discoveryUpdate devicesettings","links":["b41a4f94.069b"],"x":1235,"y":2000,"wires":[]},{"id":"b41a4f94.069b","type":"link in","z":"64c3c505.631b7c","name":"IN devicesettings","links":["ccd0d6eb.7b7bc8","e8709a07.67a788","fca82e24.56f88"],"x":655,"y":1800,"wires":[["b5824467.7f2d18"]]},{"id":"709c1c11.3cd624","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":2080,"wires":[["ab0be6df.70a218"]]},{"id":"ab0be6df.70a218","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2080,"wires":[["e7538e79.a0df1"]]},{"id":"e7538e79.a0df1","type":"function","z":"64c3c505.631b7c","name":"sort settingsInputData, forEach send lastmsgtime","func":"var settingsInputData = [];\n\nmsg.payload.forEach(function(e,i) {\n    settingsInputData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status,\n        interval: e.curinterval,\n        units: e.curunit,\n        shownDataPoints: e.showndatapoints,\n        isNotifying: e.isnotifying,\n        lastReceivedVal: e.lastmsgtime,\n        manControl: e.mancontrol,\n        linkedTo: e.linkedto,\n        threshold: e.threshold,\n        linkRule: e.linkrule,\n        linkedMeas: e.linkedMeas\n    });\n    \n    node.send({\n        payload: e.lastmsgtime,\n        topic: e.refid,\n        settingsInputData: settingsInputData,\n        dataLength: msg.payload.length\n    });\n});\n","outputs":1,"noerr":0,"x":1130,"y":2080,"wires":[["b4761df0.a8306"]]},{"id":"b4761df0.a8306","type":"moment","z":"64c3c505.631b7c","name":"","topic":"","input":"payload","inputType":"msg","inTz":"Europe/Berlin","adjAmount":"0","adjType":"hours","adjDir":"add","format":"fromNow","locale":"en_EN","output":"payload","outputType":"msg","outTz":"Europe/Berlin","x":800,"y":2140,"wires":[["5faefe19.b6d95"]]},{"id":"5faefe19.b6d95","type":"function","z":"64c3c505.631b7c","name":"attach formatted lastmsgtime","func":"\nmsg.settingsInputData.forEach(function(element, index) {\n    if (element.deviceId == msg.topic) {\n        element.lastReceivedVal = msg.payload;\n    }\n});\n\nmsg.topic = \"updateData\";\n\nif (msg.settingsInputData.length == msg.dataLength) {\n    msg.payload = \"lastItem\";\n}\nelse {\n    msg.payload = \"\";\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1060,"y":2140,"wires":[["e8709a07.67a788","87ffd660.bbd378"]]},{"id":"e8709a07.67a788","type":"link out","z":"64c3c505.631b7c","name":"OUT dataUpdate devicesettings","links":["b41a4f94.069b"],"x":1235,"y":2140,"wires":[]},{"id":"87ffd660.bbd378","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1270,"y":2180,"wires":[]},{"id":"3c4244a8.5e3bfc","type":"link in","z":"64c3c505.631b7c","name":"IN dataUpdate deviceoverview","links":["b0192ac6.35eb98","c1cb84af.9e9168"],"x":155,"y":1520,"wires":[["f9e35484.c353c8"]]},{"id":"f9e35484.c353c8","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":1520,"wires":[["dea8f91.8a10208"]]},{"id":"dea8f91.8a10208","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1520,"wires":[["932d12ce.b63aa"]]},{"id":"932d12ce.b63aa","type":"function","z":"64c3c505.631b7c","name":"sort overviewData","func":"msg.overviewData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.overviewData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\nmsg.topic = \"updateData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":1520,"wires":[["c11bf8bf.f73948"]]},{"id":"c11bf8bf.f73948","type":"link out","z":"64c3c505.631b7c","name":"OUT dataUpdate deviceoverview","links":["93acf383.a0b4c"],"x":1175,"y":1520,"wires":[]},{"id":"93acf383.a0b4c","type":"link in","z":"64c3c505.631b7c","name":"IN deviceoverview","links":["c11bf8bf.f73948"],"x":655,"y":1320,"wires":[["68094d4a.24aab4"]]},{"id":"a6936b2.b1c0a98","type":"switch","z":"64c3c505.631b7c","name":"check msg.sign","property":"sign","propertyType":"msg","rules":[{"t":"nempty"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":320,"y":540,"wires":[["4ec1ee5b.1695"],["54bcbf9b.9dafd"]]},{"id":"54bcbf9b.9dafd","type":"template","z":"64c3c505.631b7c","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout where htmlid like '%{{refid}}';","output":"str","x":580,"y":540,"wires":[["a4650d0c.554e7"]]},{"id":"465cc631.cc63f8","type":"debug","z":"64c3c505.631b7c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1330,"y":1140,"wires":[]},{"id":"4beb8cb2.cc0d64","type":"template","z":"64c3c505.631b7c","name":"select from connections where refid","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections where refid = {{payload}};","output":"str","x":540,"y":740,"wires":[["a6797357.f604c"]]},{"id":"a6797357.f604c","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":740,"wires":[["42a6255f.26b28c"]]},{"id":"42a6255f.26b28c","type":"function","z":"64c3c505.631b7c","name":"calc itemCount to add to dashboard","func":"if (msg.payload[0].refid == msg.curRefId) {\n    var measurandCount = msg.payload[0].curunit.split('').length;\n    if (msg.payload[0].types == \"MPU6050\") {\n        msg.itemCount = 2 * 3 * measurandCount;\n    }\n    else {\n        msg.itemCount = 2 * measurandCount;\n    }\n    msg.connectionData = msg.payload;\n    \n    return msg;\n}","outputs":1,"noerr":0,"x":1080,"y":740,"wires":[["6eceb9b9.c608f8"]]},{"id":"f0f2ae28.6a22","type":"function","z":"64c3c505.631b7c","name":"insert new group into uigroups","func":"msg.lastGroup = msg.payload;\n\nif (typeof msg.lastGroup !== 'undefined' && (msg.lastGroup.length > 0)) {\n    msg.newGroupNumber = (parseInt(msg.lastGroup[0].htmlid)+1);\n}\nelse {\n    msg.newGroupNumber = 1;\n}\n\nlet query = \"insert into uigroups(htmlid,name,items) values('\" \n            + msg.newGroupNumber + \"','\" \n            + msg.connectionData[0].dispname + \"','\";\n\nlet itemList = [];\n\nfor (let i = 0; i < (msg.itemCount / 2); i++) {\n    query += \"VC\";\n    itemList.push(\"value\");\n    itemList.push(\"chart\");\n}\n\nquery += \"');\";\n\nmsg.topic = query;\nmsg.itemList = itemList;\n\nreturn msg;","outputs":1,"noerr":0,"x":550,"y":860,"wires":[["de169345.f328a"]]},{"id":"6eceb9b9.c608f8","type":"template","z":"64c3c505.631b7c","name":"select highest htmlid from uigroups","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uigroups order by cast(htmlid as integer) desc limit 1;","output":"str","x":540,"y":800,"wires":[["12308b19.077685"]]},{"id":"12308b19.077685","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":800,"wires":[["f0f2ae28.6a22"]]},{"id":"de169345.f328a","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":860,"wires":[["e34dbe5e.f4328"]]},{"id":"e34dbe5e.f4328","type":"function","z":"64c3c505.631b7c","name":"insert new items into uilayout","func":"let listVal = [];\nlet listChart = [];\n\nfor (let i = 0; i < msg.itemCount; i++) {\n    let query = \"insert into uilayout(htmlid,numbergroup,numberitem) values('\";\n    let htmlId = \"\";\n    let numberGroup = msg.newGroupNumber;\n    let numberItem = (i+1);\n    let uiType = \"\";\n    let measType = \"\";\n    let deviceId = msg.connectionData[0].refid;\n    \n    \n    if ((i % 2) === 0) {\n        //item is value (default)\n        htmlId += \"val-\";\n        uiType = \"val\";\n    }\n    else if ((i % 2) == 1) {\n        // item is chart (default)\n        htmlId += \"chart-\";\n        uiType = \"chart\";\n    }\n    \n    \n    \n    switch(msg.connectionData[0].types) {\n        case 'DHT22':\n            htmlId += setMeasurementType(i, \"Temp\", \"Hum\");\n            break;\n        case 'BME280':\n            htmlId += setMeasurementType(i, \"Temp\", \"Hum\", \"Press\");\n            break;\n        case 'HCSR501':\n            htmlId += setMeasurementType(i, \"Mot\");\n            break;\n        case 'BUTTON':\n            htmlId += setMeasurementType(i, \"But\");\n            break;\n        case 'TSL2561':\n            htmlId += setMeasurementType(i, \"Lum\");\n            break;\n        case 'HCSR04':\n            htmlId += setMeasurementType(i, \"Dist\");\n            break;\n        case 'CCS811':\n            htmlId += setMeasurementType(i, \"Co2\", \"Voc\");\n            break;\n        case 'MAX44009':\n            htmlId += setMeasurementType(i, \"Lum\");\n            break;\n        case 'MPU6050':\n            htmlId += setMeasurementType(i, \"Gyro\", \"Acc\");\n            break;\n        case 'VEML6070':\n            htmlId += setMeasurementType(i, \"Uv\");\n            break;\n        case 'SI1145':\n            htmlId += setMeasurementType(i, \"Uv\");\n            break;\n        case 'MPR1121':\n            htmlId += setMeasurementType(i, \"Efi\");\n            break;\n        case 'BMP280':\n            htmlId += setMeasurementType(i, \"Temp\", \"Hum\", \"Press\", \"Voc\");\n            break;\n        case 'TX20':\n            htmlId += setMeasurementType(i, \"Wind\");\n            break;\n        case 'BLUEDOT':\n            htmlId += setMeasurementType(i, \"Temp\", \"Hum\", \"Press\", \"Lum\");\n            break;\n        case 'ANALOG':\n            htmlId += setMeasurementType(i, \"Ana\");\n            break;\n        default: \n            break;\n    }\n\n    measType = htmlId.split('-')[1];\n\n    htmlId += \"-\" + deviceId;\n    query += htmlId + \"',\";\n    \n    query += numberGroup + \",\";\n    \n    query += numberItem + \");\";\n    \n    node.send({\n        topic: query,\n        connectionData: msg.connectionData,\n        curRefId: msg.curRefId,\n        itemCount: msg.itemCount,\n        itemList: msg.itemList,\n        itemData: {\n            htmlId: htmlId,\n            numberGroup: numberGroup,\n            numberItem: numberItem,\n            uiType: uiType,\n            measType: measType,\n            deviceId: deviceId\n        }\n    });\n}\n\n\nfunction setMeasurementType(i, text1=\"\", text2=\"\", text3=\"\", text4=\"\", text5=\"\", text6=\"\") {\n    switch(i) {\n        case 0:\n        case 1:\n            return text1;\n            break;\n        case 2:\n        case 3:\n            return text2;\n            break;\n        case 4:\n        case 5:\n            return text3;\n            break;\n        case 6:\n        case 7:\n            return text4;\n            break;\n        case 8:\n        case 9:\n            return text5;\n            break;\n        case 10:\n        case 11:\n            return text6;\n            break;\n        default:\n            return \"\";\n            break;\n    }\n}","outputs":1,"noerr":0,"x":360,"y":920,"wires":[["d122515c.b854c"]]},{"id":"a7b786f.361c478","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":920,"wires":[["2726231c.287b4c"]]},{"id":"f2bdfc37.23df3","type":"link out","z":"64c3c505.631b7c","name":"OUT devicesettings","links":["bc5949d4.d8af28","10e54338.d9be0d","4e880aa8.e161a4"],"x":955,"y":1760,"wires":[]},{"id":"577e8360.19782c","type":"function","z":"64c3c505.631b7c","name":"forEach send check if table exists","func":"msg.dashboardData.forEach(function(e, i) {\n    var tempTopic = \"\";\n\n    if (e.htmlId.includes(\"Hum\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS H_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Temp\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS T_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Press\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS P_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Mot\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS M_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"But\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS B_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Lum\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS L_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Dist\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS D_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Co2\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS C_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Voc\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS V_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Gyro\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS G_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Acc\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS A_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Uv\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS U_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Efi\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS E_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Wind\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS W_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    else if (e.htmlId.includes(\"Ana\")) {\n        tempTopic = \"CREATE TABLE IF NOT EXISTS O_\" + e.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n    }\n    \n    \n    var isComplete = false;\n    if (i == (msg.dashboardData.length -1)) {\n        //is last element\n        isComplete = true;\n    }\n    \n    if (isComplete) {\n        node.send({\n            \"topic\": tempTopic,\n            \"curItem\": e.htmlId,\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"index\": i,\n            \"parts\": { \"index\": i },\n            \"complete\": isComplete\n        });\n    }\n    else {\n        node.send({\n            \"topic\": tempTopic,\n            \"dashboardData\": msg.dashboardData,\n            \"dashboardGroups\": msg.dashboardGroups,\n            \"index\": i,\n            \"parts\": { \"index\": i }\n        });\n    }\n});\n\n//return msg;","outputs":1,"noerr":0,"x":340,"y":240,"wires":[["477dfcb8.e0b0d4"]]},{"id":"381aef3c.7b6a5","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":240,"wires":[["93714fcb.2bb97"]]},{"id":"929b49fc.6b88f8","type":"link out","z":"64c3c505.631b7c","name":"OUT discoverUpdate dashboard","links":["4ebd018a.a230f"],"x":1295,"y":1100,"wires":[]},{"id":"2726231c.287b4c","type":"function","z":"64c3c505.631b7c","name":"send select showndatapoints where refId matching","func":"if (msg.itemData.htmlId.includes(\"chart\")) {\n        node.send({\n        \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + msg.itemData.deviceId.toString() + \";\",\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n        });\n}\nelse if (msg.itemData.htmlId.includes(\"val\")) {\n        node.send({\n        \"topic\": \"select showndatapoints,dispname,status from connections where refid = \" + msg.itemData.deviceId.toString() + \";\",\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n        });\n}\n\n//return msg;","outputs":1,"noerr":0,"x":490,"y":980,"wires":[["2ddebb31.993744"]]},{"id":"2ddebb31.993744","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":980,"wires":[["5da7c6af.611018"]]},{"id":"5da7c6af.611018","type":"function","z":"64c3c505.631b7c","name":"include in dashboardData","func":"//extract device id from sql query / topic\nvar deviceId = msg.topic.split(\"= \")[1].split(\";\")[0];\n\nif (msg.itemData.htmlId.includes(\"chart\") && msg.itemData.htmlId.includes(deviceId)) {\n    msg.itemData.shownDataPoints = msg.payload[0].showndatapoints;\n    msg.itemData.dispName = msg.payload[0].dispname;\n    msg.itemData.deviceStatus = msg.payload[0].status;\n}\nelse if(msg.itemData.htmlId.includes(deviceId)) {\n    msg.itemData.dispName = msg.payload[0].dispname;\n    msg.itemData.deviceStatus = msg.payload[0].status;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1050,"y":980,"wires":[["c8e80fa.e2fc0f"]]},{"id":"c8e80fa.e2fc0f","type":"function","z":"64c3c505.631b7c","name":"send check if table exists","func":"var tempTopic = \"\";\n\nif (msg.itemData.htmlId.includes(\"Hum\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS H_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Temp\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS T_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Press\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS P_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Mot\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS M_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"But\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS B_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Lum\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS L_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Dist\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS D_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Co2\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS C_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Voc\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS V_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Gyro\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS G_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Acc\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS A_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Uv\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS U_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Efi\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS E_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Wind\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS W_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\nelse if (msg.itemData.htmlId.includes(\"Ana\")) {\n    tempTopic = \"CREATE TABLE IF NOT EXISTS O_\" + msg.itemData.deviceId.toString() + \"(id INTEGER PRIMARY KEY AUTOINCREMENT,timehr TEXT, timeunix INTEGER, value REAL);\";\n}\n\nnode.send({\n    \"topic\": tempTopic,\n    \"curItem\": msg.itemData.htmlId,\n    \"itemData\": msg.itemData,\n    \"itemList\": msg.itemList,\n    \"_socketId\": msg._socketId\n});\n\n//return msg;","outputs":1,"noerr":0,"x":570,"y":1040,"wires":[["7943d051.5c395"]]},{"id":"7943d051.5c395","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1040,"wires":[["8dec3ff0.b4bf"]]},{"id":"8dec3ff0.b4bf","type":"function","z":"64c3c505.631b7c","name":"send select datapoints","func":"var tempTopic = \"\";\n\nif (msg.itemData.htmlId.includes(\"chart\") && typeof msg.itemData.shownDataPoints !== 'undefined') {\n    if (msg.itemData.htmlId.includes(\"Hum\")) {\n        tempTopic = \"select * from H_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Temp\")) {\n        tempTopic = \"select * from T_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Press\")) {\n        tempTopic = \"select * from P_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Mot\")) {\n        tempTopic = \"select * from M_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"But\")) {\n        tempTopic = \"select * from B_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Lum\")) {\n        tempTopic = \"select * from L_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Dist\")) {\n        tempTopic = \"select * from D_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Co2\")) {\n        tempTopic = \"select * from C_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Voc\")) {\n        tempTopic = \"select * from V_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Gyro\")) {\n        tempTopic = \"select * from G_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Acc\")) {\n        tempTopic = \"select * from A_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Uv\")) {\n        tempTopic = \"select * from U_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Efi\")) {\n        tempTopic = \"select * from E_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Wind\")) {\n        tempTopic = \"select * from W_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Ana\")) {\n        tempTopic = \"select * from O_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit \" + msg.itemData.shownDataPoints + \";\";\n    }\n    \n    node.send({\n        \"topic\": tempTopic,\n        \"curItem\": msg.itemData.htmlId,\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n    });\n}\nelse if (msg.itemData.htmlId.includes(\"val\")) {\n    if (msg.itemData.htmlId.includes(\"Hum\")) {\n        tempTopic = \"select * from H_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Temp\")) {\n        tempTopic = \"select * from T_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Press\")) {\n        tempTopic = \"select * from P_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Mot\")) {\n        tempTopic = \"select * from M_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"But\")) {\n        tempTopic = \"select * from B_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Lum\")) {\n        tempTopic = \"select * from L_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Dist\")) {\n        tempTopic = \"select * from D_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Co2\")) {\n        tempTopic = \"select * from C_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Voc\")) {\n        tempTopic = \"select * from V_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Gyro\")) {\n        tempTopic = \"select * from G_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Acc\")) {\n        tempTopic = \"select * from A_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Uv\")) {\n        tempTopic = \"select * from U_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Efi\")) {\n        tempTopic = \"select * from E_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Wind\")) {\n        tempTopic = \"select * from W_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    else if (msg.itemData.htmlId.includes(\"Ana\")) {\n        tempTopic = \"select * from O_\"+ msg.itemData.deviceId.toString() + \" order by id desc limit 1;\";\n    }\n    \n    node.send({\n        \"topic\": tempTopic,\n        \"curItem\": msg.itemData.htmlId,\n        \"itemData\": msg.itemData,\n        \"itemList\": msg.itemList,\n        \"_socketId\": msg._socketId\n    });\n}\n\n//return msg;","outputs":1,"noerr":0,"x":580,"y":1100,"wires":[["fdb84c12.31fb3"]]},{"id":"fdb84c12.31fb3","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":1100,"wires":[["9df1f3db.ad7e6"]]},{"id":"9df1f3db.ad7e6","type":"function","z":"64c3c505.631b7c","name":"include DataPoints in itemData","func":"if (msg.curItem == msg.itemData.htmlId) {\n    //reverse data from db and save in dashboardData object\n    msg.itemData.DataPoints = msg.payload.reverse();\n}\n\nmsg.topic = \"discoveryData\";\n\nreturn msg;","outputs":1,"noerr":0,"x":1070,"y":1100,"wires":[["465cc631.cc63f8","929b49fc.6b88f8"]]},{"id":"164be2ec.ee8e5d","type":"comment","z":"64c3c505.631b7c","name":"Discovery, add new uigroup and items","info":"","x":290,"y":700,"wires":[]},{"id":"eb76a666.673048","type":"link out","z":"64c3c505.631b7c","name":"OUT dashboard","links":["d65b6510.b95638"],"x":955,"y":360,"wires":[]},{"id":"77a554ef.bd8cec","type":"comment","z":"9648297c.564688","name":"DASHBOARD Save new group name or save new item position","info":"","x":250,"y":1540,"wires":[]},{"id":"d65b6510.b95638","type":"link in","z":"9648297c.564688","name":"IN save group name","links":["eb76a666.673048"],"x":175,"y":1720,"wires":[["f1e2b552.ace368"]]},{"id":"f1e2b552.ace368","type":"switch","z":"9648297c.564688","name":"check topic","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"groupNameEdit","vt":"str"},{"t":"eq","v":"itemPositionEdit","vt":"str"},{"t":"eq","v":"removeGroupAndItems","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":290,"y":1720,"wires":[["dcfb495a.381e18"],["6a1e3a82.baf1f4"],["9cd1f052.6c867"]]},{"id":"dcfb495a.381e18","type":"change","z":"9648297c.564688","name":"","rules":[{"t":"move","p":"payload.htmlId","pt":"msg","to":"htmlId","tot":"msg"},{"t":"move","p":"payload.name","pt":"msg","to":"name","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":460,"y":1620,"wires":[["333607f7.cda768"]]},{"id":"333607f7.cda768","type":"template","z":"9648297c.564688","name":"update uigroups","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update uigroups set name = '{{name}}' where htmlid = '{{htmlId}}';","output":"str","x":660,"y":1620,"wires":[["2cc05c7e.469864"]]},{"id":"2cc05c7e.469864","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1620,"wires":[["d11cb380.d644e"]]},{"id":"d11cb380.d644e","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":1620,"wires":[]},{"id":"bbcc0e77.b7a04","type":"uibuilder","z":"64c3c505.631b7c","name":"","topic":"","url":"mqttinfo","fwdInMessages":false,"allowScripts":false,"allowStyles":false,"debugFE":false,"copyIndex":true,"template":"","filename":"index.html","format":"html","x":780,"y":2460,"wires":[[],["631dc225.353c3c"]]},{"id":"2ca62c0.2f57cd4","type":"comment","z":"64c3c505.631b7c","name":"MQTTINFO Autosending on page load","info":"","x":170,"y":2340,"wires":[]},{"id":"631dc225.353c3c","type":"link out","z":"64c3c505.631b7c","name":"OUT mqttInfo ctrl","links":["41c493ba.e1e86c"],"x":955,"y":2500,"wires":[]},{"id":"41c493ba.e1e86c","type":"link in","z":"64c3c505.631b7c","name":"IN mqttInfo ctrl","links":["631dc225.353c3c"],"x":35,"y":2380,"wires":[["dd65d53d.91c5e8"]]},{"id":"dd65d53d.91c5e8","type":"switch","z":"64c3c505.631b7c","name":"ui ctrl","property":"uibuilderCtrl","propertyType":"msg","rules":[{"t":"eq","v":"client connect","vt":"str"},{"t":"eq","v":"ready for content","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":130,"y":2380,"wires":[["a568f27b.2df9e"],["a568f27b.2df9e"],[]]},{"id":"a568f27b.2df9e","type":"change","z":"64c3c505.631b7c","name":"","rules":[{"t":"delete","p":"uibuilderCtrl","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":310,"y":2380,"wires":[["9b10aab3.308248"]]},{"id":"9b10aab3.308248","type":"template","z":"64c3c505.631b7c","name":"select * from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from connections;","output":"str","x":570,"y":2380,"wires":[["1ac5a9fc.2525c6"]]},{"id":"1ac5a9fc.2525c6","type":"sqlite","z":"64c3c505.631b7c","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":810,"y":2380,"wires":[["122e6328.e4129d"]]},{"id":"122e6328.e4129d","type":"function","z":"64c3c505.631b7c","name":"sort data","func":"msg.connectionData = [];\n\nmsg.payload.forEach(function(e,i) {\n    msg.connectionData.push({\n        deviceId: e.refid,\n        deviceIp: e.IP,\n        dispName: e.dispname,\n        deviceCategory: e.category,\n        deviceType: e.types,\n        isVisible: e.isvisible,\n        status: e.status\n    });\n});\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1000,"y":2380,"wires":[["5734b35e.f9e7ec"]]},{"id":"5734b35e.f9e7ec","type":"function","z":"64c3c505.631b7c","name":"generate topic list in mqttData","func":"msg.mqttData = [];\n\nmsg.connectionData.forEach(function(element) {\n    setTopics(element.deviceType, element.deviceId, element.dispName);\n});\n\n\nmsg.topic = \"onLoadData\";\n\nreturn msg;\n\n\nfunction setTopics(deviceType, deviceId, deviceName) {\n    switch(deviceType) {\n        case \"BMP280\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/VOC/\" + deviceId,\n                \"name\": deviceName\n            });\n        case \"BME280\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/pressure/\" + deviceId,\n                \"name\": deviceName\n            });\n        case \"DHT22\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/humidity/\" + deviceId,\n                \"name\": deviceName\n            });\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/temperature/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"ANALOG\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/analog/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"VEML6070\":\n        case \"SI1145\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/UV/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"HCSR501\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/motion/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"HCSR04\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/distance/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"CCS811\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/VOC/\" + deviceId,\n                \"name\": deviceName\n            });\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/CO2/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"BUTTON\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/button/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"TSL2561\":\n        case \"MAX44009\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/luminous/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"MPU6050\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/gyro/\" + deviceId,\n                \"name\": deviceName\n            });\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/acceleration/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"MPR1121\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/E-field/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"TX20\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/wind/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"ANALOG\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/analog/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        case \"BLUEDOT\":\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/temperature/\" + deviceId,\n                \"name\": deviceName\n            });\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/humidity/\" + deviceId,\n                \"name\": deviceName\n            });\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/pressure/\" + deviceId,\n                \"name\": deviceName\n            });\n            msg.mqttData.push({\n                \"mqttTopic\": \"sensors/luminous/\" + deviceId,\n                \"name\": deviceName\n            });\n            break;\n        default:\n            break;\n    }\n}","outputs":1,"noerr":0,"x":550,"y":2460,"wires":[["bbcc0e77.b7a04","9d3f56a3.434388"]]},{"id":"9d3f56a3.434388","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":770,"y":2520,"wires":[]},{"id":"34a8f31a.e0d5ec","type":"join","z":"64c3c505.631b7c","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"index","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":990,"y":180,"wires":[["93c860a8.4ff01"]]},{"id":"a490dee9.05dd8","type":"delay","z":"64c3c505.631b7c","name":"","pauseType":"rate","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":true,"x":290,"y":100,"wires":[["74462a6b.1bf1c4"]]},{"id":"696b839c.81fc0c","type":"delay","z":"64c3c505.631b7c","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":180,"wires":[["3b3f29cf.c8d766"]]},{"id":"93714fcb.2bb97","type":"join","z":"64c3c505.631b7c","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"index","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":990,"y":240,"wires":[["6e274d47.dc8e94"]]},{"id":"477dfcb8.e0b0d4","type":"delay","z":"64c3c505.631b7c","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":240,"wires":[["381aef3c.7b6a5"]]},{"id":"1b3b332a.bf2d6d","type":"delay","z":"64c3c505.631b7c","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":300,"wires":[["5922bf4a.42b5c"]]},{"id":"bf2ddf0d.16ef7","type":"join","z":"64c3c505.631b7c","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"index","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":990,"y":300,"wires":[["182cae5f.3a62d2","d1339108.f1f12"]]},{"id":"d1339108.f1f12","type":"debug","z":"64c3c505.631b7c","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1130,"y":300,"wires":[]},{"id":"b67c22f6.3ce91","type":"join","z":"64c3c505.631b7c","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"index","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":990,"y":600,"wires":[["e962d952.cbded8"]]},{"id":"e4e9df54.ff6d3","type":"delay","z":"64c3c505.631b7c","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":600,"wires":[["63ebbba8.67ee54"]]},{"id":"b60f5ae0.3b8128","type":"delay","z":"64c3c505.631b7c","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":660,"wires":[["f6a4f0b5.1db4"]]},{"id":"2725cb42.5af854","type":"function","z":"64c3c505.631b7c","name":"forEach send select datapoints","func":"msg.dashboardData.forEach(function(e, i) {\n    var tempTopic = \"\";\n\n    if (e.htmlId.includes(\"chart\") && typeof e.shownDataPoints !== 'undefined') {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n        else if (e.htmlId.includes(\"Ana\")) {\n            tempTopic = \"select * from O_\"+ e.deviceId.toString() + \" order by id desc limit \" + e.shownDataPoints + \";\";\n        }\n\n        \n        var isComplete = false;\n        if (i == (msg.dashboardData.length -1)) {\n            //is last element\n            isComplete = true;\n        }\n        \n        if (isComplete) {\n            node.send({\n                \"topic\": tempTopic,\n                \"curItem\": e.htmlId,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i },\n                \"complete\": isComplete\n            });\n        }\n        else {\n            node.send({\n                \"topic\": tempTopic,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i }\n            });\n        }\n    }\n    else if (e.htmlId.includes(\"val\")) {\n        if (e.htmlId.includes(\"Hum\")) {\n            tempTopic = \"select * from H_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Temp\")) {\n            tempTopic = \"select * from T_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Press\")) {\n            tempTopic = \"select * from P_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Mot\")) {\n            tempTopic = \"select * from M_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"But\")) {\n            tempTopic = \"select * from B_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Lum\")) {\n            tempTopic = \"select * from L_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Dist\")) {\n            tempTopic = \"select * from D_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Co2\")) {\n            tempTopic = \"select * from C_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Voc\")) {\n            tempTopic = \"select * from V_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Gyro\")) {\n            tempTopic = \"select * from G_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Acc\")) {\n            tempTopic = \"select * from A_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Uv\")) {\n            tempTopic = \"select * from U_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Efi\")) {\n            tempTopic = \"select * from E_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Wind\")) {\n            tempTopic = \"select * from W_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        else if (e.htmlId.includes(\"Ana\")) {\n            tempTopic = \"select * from O_\"+ e.deviceId.toString() + \" order by id desc limit 1;\";\n        }\n        \n\n        var isComplete = false;\n        if (i == (msg.dashboardData.length -1)) {\n            //is last element\n            isComplete = true;\n        }\n        \n        if (isComplete) {\n            node.send({\n                \"topic\": tempTopic,\n                \"curItem\": e.htmlId,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i },\n                \"complete\": isComplete\n            });\n        }\n        else {\n            node.send({\n                \"topic\": tempTopic,\n                \"dashboardData\": msg.dashboardData,\n                \"dashboardGroups\": msg.dashboardGroups,\n                \"index\": i,\n                \"parts\": { \"index\": i }\n            });\n        }\n    }\n});\n\n//return msg;","outputs":1,"noerr":0,"x":350,"y":660,"wires":[["b60f5ae0.3b8128"]]},{"id":"d122515c.b854c","type":"delay","z":"64c3c505.631b7c","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":600,"y":920,"wires":[["a7b786f.361c478"]]},{"id":"e516db3d.8fac88","type":"switch","z":"64c3c505.631b7c","name":"msg.changedSettings","property":"changedSettings","propertyType":"msg","rules":[{"t":"else"},{"t":"true"}],"checkall":"true","repair":false,"outputs":2,"x":300,"y":1700,"wires":[["2bcdf339.85baac"],["ea7fbf74.48f2e"]]},{"id":"ea7fbf74.48f2e","type":"link out","z":"64c3c505.631b7c","name":"OUT devicesettings ctrl trigger","links":["583d15e0.008b1c"],"x":475,"y":1720,"wires":[]},{"id":"1bb9dbb5.1d1474","type":"join","z":"64c3c505.631b7c","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"index","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":990,"y":660,"wires":[["9557844d.e9a5c8"]]},{"id":"a48f1067.148a6","type":"switch","z":"9648297c.564688","name":"check topic","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"settingsSensor","vt":"str"},{"t":"eq","v":"settingsActuator","vt":"str"},{"t":"eq","v":"removeDevice","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":290,"y":1160,"wires":[["6f1f439a.00cddc"],[],["af87658a.f44e48"]]},{"id":"537de801.7b7648","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":830,"y":1500,"wires":[]},{"id":"af87658a.f44e48","type":"change","z":"9648297c.564688","name":"","rules":[{"t":"set","p":"deviceId","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1260,"wires":[["4409e864.280538"]]},{"id":"4409e864.280538","type":"template","z":"9648297c.564688","name":"delete from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"delete from uilayout where htmlid like '%{{deviceId}}';","output":"str","x":570,"y":1260,"wires":[["7bddcf09.81a2f"]]},{"id":"7bddcf09.81a2f","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1260,"wires":[["bf19d83f.ddbfb8"]]},{"id":"bf19d83f.ddbfb8","type":"template","z":"9648297c.564688","name":"delete from connections","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"delete from connections where refid = '{{deviceId}}';","output":"str","x":590,"y":1320,"wires":[["5d8739fd.135db8"]]},{"id":"5d8739fd.135db8","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1320,"wires":[["482bc52f.62350c"]]},{"id":"8e385d5d.4bee1","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT \n    name\nFROM \n    sqlite_master \nWHERE \n    type ='table' AND \n    name LIKE '%100100205';","name":"","x":870,"y":1380,"wires":[["c421fc6d.06398","b6fb8465.b28b38"]]},{"id":"482bc52f.62350c","type":"template","z":"9648297c.564688","name":"select table names with deviceId","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"SELECT \n    name\nFROM \n    sqlite_master \nWHERE \n    type ='table' AND \n    name LIKE '%{{deviceId}}';","output":"str","x":610,"y":1380,"wires":[["8e385d5d.4bee1"]]},{"id":"c421fc6d.06398","type":"function","z":"9648297c.564688","name":"forEach drop log table","func":"msg.payload.forEach(function(element) {\n    msg.topic = \"drop table \" + element.name + \";\";\n    \n    node.send(msg);\n});","outputs":1,"noerr":0,"x":340,"y":1440,"wires":[["71ca634a.0f57bc"]]},{"id":"71ca634a.0f57bc","type":"delay","z":"9648297c.564688","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":560,"y":1440,"wires":[["15c62bc9.96a3a4","537de801.7b7648"]]},{"id":"15c62bc9.96a3a4","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"SELECT \n    name\nFROM \n    sqlite_master \nWHERE \n    type ='table' AND \n    name LIKE '%100100205';","name":"","x":870,"y":1440,"wires":[[]]},{"id":"b20fe2ea.58993","type":"comment","z":"18000974.c23df7","name":"generate unix time in ms","info":"","x":110,"y":260,"wires":[]},{"id":"cc1aebce.7fb918","type":"moment","z":"18000974.c23df7","name":"","topic":"","input":"","inputType":"date","inTz":"Europe/Berlin","adjAmount":0,"adjType":"days","adjDir":"add","format":"unix","locale":"de_DE","output":"timeunix","outputType":"msg","outTz":"Europe/Berlin","x":360,"y":260,"wires":[["ac54cba8.ab4898"]]},{"id":"ac54cba8.ab4898","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"change","p":"timeunix","pt":"msg","from":"uni","fromt":"str","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":260,"wires":[["8cc55e37.ab3e"]]},{"id":"b6fb8465.b28b38","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1070,"y":1380,"wires":[]},{"id":"1ea821d9.d1974e","type":"comment","z":"9648297c.564688","name":"remove a device","info":"","x":360,"y":1220,"wires":[]},{"id":"ec7d5c04.724fe","type":"comment","z":"9648297c.564688","name":"save sensor settings","info":"","x":430,"y":940,"wires":[]},{"id":"9e1ad9ff.78a248","type":"switch","z":"64c3c505.631b7c","name":"msg.removedDevice","property":"removedDevice","propertyType":"msg","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":300,"y":1740,"wires":[["ea7fbf74.48f2e"]]},{"id":"9341afd9.057e4","type":"switch","z":"18000974.c23df7","name":"check for curRefId","property":"curRefId","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"num"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":380,"wires":[["18ddd4c4.2a3f6b"],["40105819.340e48"]]},{"id":"40105819.340e48","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"curRefId","pt":"msg","to":"payload[0].refid","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":150,"y":440,"wires":[["775fabd4.570e54"]]},{"id":"775fabd4.570e54","type":"template","z":"18000974.c23df7","name":"update lastmsgtime","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set lastmsgtime = {{timeunix}} where refid = {{curRefId}};","output":"str","x":370,"y":440,"wires":[["dff21457.d708b8"]]},{"id":"dff21457.d708b8","type":"sqlite","z":"18000974.c23df7","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":590,"y":440,"wires":[["15c1172d.026969","fce56321.704bc"]]},{"id":"15c1172d.026969","type":"change","z":"18000974.c23df7","name":"delete msg properties","rules":[{"t":"delete","p":"topic","pt":"msg"},{"t":"delete","p":"txpayload","pt":"msg"},{"t":"delete","p":"ips","pt":"msg"},{"t":"delete","p":"reference","pt":"msg"},{"t":"delete","p":"timeunix","pt":"msg"},{"t":"delete","p":"curRefId","pt":"msg"},{"t":"delete","p":"payload","pt":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":840,"y":440,"wires":[["aaaa80ad.e70d9"]]},{"id":"aaaa80ad.e70d9","type":"link out","z":"18000974.c23df7","name":"OUT discovery reconnect","links":["f61bdc0d.33039"],"x":975,"y":440,"wires":[]},{"id":"f61bdc0d.33039","type":"link in","z":"abe36278.d3a5e","name":"IN disconnect watchdog","links":["aaaa80ad.e70d9"],"x":195,"y":2880,"wires":[["c152e79f.413c98"]]},{"id":"fc0275b4.2b62b8","type":"mqtt out","z":"18000974.c23df7","name":"","topic":"discovery/master","qos":"","retain":"","broker":"3bd1ba7.f516946","x":1050,"y":500,"wires":[]},{"id":"fce56321.704bc","type":"change","z":"18000974.c23df7","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"curRefId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":820,"y":500,"wires":[["fc0275b4.2b62b8","4b2c8c2c.a62804"]]},{"id":"65b3ae1c.3bfee","type":"debug","z":"abe36278.d3a5e","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":1760,"wires":[]},{"id":"3abc022f.98c5be","type":"mqtt in","z":"abe36278.d3a5e","name":"","topic":"sensors/analog/+","qos":"2","datatype":"auto","broker":"3bd1ba7.f516946","x":140,"y":1800,"wires":[["f5057554.20e858"]]},{"id":"f5057554.20e858","type":"function","z":"abe36278.d3a5e","name":"backup payload and extract refId","func":"msg.txpayload = msg.payload;\nmsg.payload = msg.topic.replace('sensors/analog/','');\nmsg.sign=\"O_\"\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":1800,"wires":[["65b3ae1c.3bfee","b045af00.49371"]]},{"id":"b045af00.49371","type":"link out","z":"abe36278.d3a5e","name":"OUT sensors/analog","links":["f50b416e.1fdee"],"x":695,"y":1800,"wires":[]},{"id":"da0d9bf.ceb1468","type":"comment","z":"9648297c.564688","name":"save new group name","info":"","x":480,"y":1580,"wires":[]},{"id":"1f450e.5ce1caf3","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1290,"y":2160,"wires":[]},{"id":"aac8e3a4.49e3c","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":2060,"wires":[["43475327.361ecc"]]},{"id":"9cd1f052.6c867","type":"template","z":"9648297c.564688","name":"delete group from uigroups","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"delete from uigroups where htmlid = {{group}};","output":"str","x":620,"y":2060,"wires":[["aac8e3a4.49e3c"]]},{"id":"43475327.361ecc","type":"template","z":"9648297c.564688","name":"delete group items from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"delete from uilayout where numbergroup = {{group}};","output":"str","x":610,"y":2120,"wires":[["a018d59a.012238"]]},{"id":"a018d59a.012238","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":2120,"wires":[["47e99518.3a455c"]]},{"id":"47e99518.3a455c","type":"change","z":"9648297c.564688","name":"delete msg properties","rules":[{"t":"delete","p":"topic","pt":"msg"},{"t":"delete","p":"items","pt":"msg"},{"t":"delete","p":"payload","pt":"msg"},{"t":"delete","p":"group","pt":"msg"},{"t":"set","p":"uibuilderCtrl","pt":"msg","to":"ready for content","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1100,"y":2120,"wires":[["1f450e.5ce1caf3","98f475a1.c5bcb8"]]},{"id":"98f475a1.c5bcb8","type":"link out","z":"9648297c.564688","name":"OUT delete dashboard group","links":["8522f4ba.537b88"],"x":1255,"y":2120,"wires":[]},{"id":"cd5fe4f4.aa8398","type":"comment","z":"9648297c.564688","name":"remove a group","info":"","x":460,"y":2020,"wires":[]},{"id":"4589d7c1.1ab4b8","type":"template","z":"9648297c.564688","name":"update connections entry","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"update connections set dispname = '{{dispName}}', isvisible = '{{isVisible}}', curinterval = '{{interval}}', showndatapoints = '{{shownDataPoints}}' where refid = {{deviceId}};","output":"str","x":590,"y":1040,"wires":[["a85f3385.46ced"]]},{"id":"a85f3385.46ced","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1040,"wires":[["a59263ba.2aa16","5d2952cb.e0f03c"]]},{"id":"a59263ba.2aa16","type":"change","z":"9648297c.564688","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"deviceId","tot":"msg"},{"t":"set","p":"payload","pt":"msg","to":"interval","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":1040,"wires":[["9428743c.a07ce8","d226c6f7.31e318"]]},{"id":"5d2952cb.e0f03c","type":"function","z":"9648297c.564688","name":"check if isvisible changed","func":"if (msg.isVisible != msg.oldIsVisible[0].isvisible) {\n    if (msg.isVisible) {\n        msg.addDelete = true;\n    }\n    else {\n        msg.addDelete = false;\n    }\n    \n    \n    return msg;\n}\n","outputs":1,"noerr":0,"x":590,"y":1100,"wires":[["3171fbad.d7fdb4"]]},{"id":"4519fba7.92cb74","type":"template","z":"9648297c.564688","name":"read old isvisible value","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select isvisible from connections where refid = {{deviceId}};","output":"str","x":580,"y":980,"wires":[["115466da.b3a6b9"]]},{"id":"115466da.b3a6b9","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":980,"wires":[["594995b2.68faac"]]},{"id":"594995b2.68faac","type":"change","z":"9648297c.564688","name":"","rules":[{"t":"move","p":"payload","pt":"msg","to":"oldIsVisible","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1090,"y":980,"wires":[["4589d7c1.1ab4b8"]]},{"id":"f3e85703.9d2578","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1250,"y":1140,"wires":[]},{"id":"3171fbad.d7fdb4","type":"switch","z":"9648297c.564688","name":"","property":"addDelete","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":830,"y":1100,"wires":[["fbfc1507.62b5f8"],["f3c74a25.4043d8"]]},{"id":"e3d1eb5a.5d6a08","type":"link out","z":"9648297c.564688","name":"OUT save sensorsettings","links":["188d5e14.94cbb2"],"x":1215,"y":1100,"wires":[]},{"id":"fbfc1507.62b5f8","type":"change","z":"9648297c.564688","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"deviceId","tot":"msg"},{"t":"move","p":"deviceId","pt":"msg","to":"curRefId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1080,"y":1100,"wires":[["e3d1eb5a.5d6a08","f3e85703.9d2578"]]},{"id":"f3c74a25.4043d8","type":"template","z":"9648297c.564688","name":"delete from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"delete from uilayout where htmlid like '%{{deviceId}}';","output":"str","x":570,"y":1160,"wires":[["97bd6902.6123f8"]]},{"id":"97bd6902.6123f8","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1160,"wires":[["c89eb797.63ffb8"]]},{"id":"c89eb797.63ffb8","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":1160,"wires":[]},{"id":"4e880aa8.e161a4","type":"link in","z":"57a86fb4.0e54e","name":"IN generate csv","links":["f2bdfc37.23df3"],"x":155,"y":320,"wires":[["e1aa6164.b463a"]]},{"id":"e1aa6164.b463a","type":"switch","z":"57a86fb4.0e54e","name":"check topic","property":"topic","propertyType":"msg","rules":[{"t":"eq","v":"generateCSV","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":150,"y":360,"wires":[["a3fdd85c.194d68"]]},{"id":"dd135ae4.85b9a8","type":"switch","z":"57a86fb4.0e54e","name":"switch sensorType","property":"sensorType","propertyType":"msg","rules":[{"t":"eq","v":"BME280","vt":"str"},{"t":"eq","v":"BMP280","vt":"str"},{"t":"eq","v":"BUTTON","vt":"str"},{"t":"eq","v":"CCS811","vt":"str"},{"t":"eq","v":"DHT22","vt":"str"},{"t":"eq","v":"HCSR04","vt":"str"},{"t":"eq","v":"HCSR501","vt":"str"},{"t":"eq","v":"MAX44009","vt":"str"},{"t":"eq","v":"MPR121","vt":"str"},{"t":"eq","v":"MPU6050","vt":"str"},{"t":"eq","v":"SI1145","vt":"str"},{"t":"eq","v":"TSL2561","vt":"str"},{"t":"eq","v":"TX20","vt":"str"},{"t":"eq","v":"VEML6070","vt":"str"},{"t":"eq","v":"ANALOG","vt":"str"},{"t":"eq","v":"BLUEDOT","vt":"str"}],"checkall":"true","repair":false,"outputs":16,"x":170,"y":580,"wires":[["f475b689.619c68"],["f475b689.619c68"],["349b4c97.c55894"],["ac52e46b.4845d8"],["f475b689.619c68"],["683b9df7.b5bc94"],["9e46e32.4dc172"],["f839b66c.226058"],["b1a3b6b.ab41548"],["57bef79b.6e2428"],["f3603d6.b1eb4c"],["f839b66c.226058"],["a6fd8c01.bc3a3"],["f3603d6.b1eb4c"],["e54828ff.27f8a8"],["f475b689.619c68"]]},{"id":"f475b689.619c68","type":"template","z":"57a86fb4.0e54e","name":"select temperature","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from T_{{sensorId}};","output":"str","x":450,"y":280,"wires":[["bffa840d.df11c8"]]},{"id":"bffa840d.df11c8","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":280,"wires":[["b6b453fa.bfd4d"]]},{"id":"b6b453fa.bfd4d","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":280,"wires":[["86dddeee.8ebac"]]},{"id":"9c553b46.42dba8","type":"switch","z":"57a86fb4.0e54e","name":"switch sensorType","property":"sensorType","propertyType":"msg","rules":[{"t":"eq","v":"BME280","vt":"str"},{"t":"eq","v":"BMP280","vt":"str"},{"t":"eq","v":"BUTTON","vt":"str"},{"t":"eq","v":"CCS811","vt":"str"},{"t":"eq","v":"DHT22","vt":"str"},{"t":"eq","v":"HCSR04","vt":"str"},{"t":"eq","v":"HCSR501","vt":"str"},{"t":"eq","v":"MAX44009","vt":"str"},{"t":"eq","v":"MPR121","vt":"str"},{"t":"eq","v":"MPU6050","vt":"str"},{"t":"eq","v":"SI1145","vt":"str"},{"t":"eq","v":"TSL2561","vt":"str"},{"t":"eq","v":"TX20","vt":"str"},{"t":"eq","v":"VEML6070","vt":"str"},{"t":"eq","v":"ANALOG","vt":"str"},{"t":"eq","v":"BLUEDOT","vt":"str"}],"checkall":"true","repair":false,"outputs":16,"x":170,"y":1100,"wires":[["be32d90c.9e54f8"],["be32d90c.9e54f8"],["3e4dd02d.7171b"],["168d4a08.e912d6"],["be32d90c.9e54f8"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["a564710d.c45c1"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["3e4dd02d.7171b"],["be32d90c.9e54f8"]]},{"id":"349b4c97.c55894","type":"template","z":"57a86fb4.0e54e","name":"select button","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from B_{{sensorId}};","output":"str","x":430,"y":340,"wires":[["36015149.aaa13e"]]},{"id":"36015149.aaa13e","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":340,"wires":[["d66a79aa.0a5fe8"]]},{"id":"d66a79aa.0a5fe8","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":340,"wires":[["e4e94048.64378"]]},{"id":"ac52e46b.4845d8","type":"template","z":"57a86fb4.0e54e","name":"select CO2","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from C_{{sensorId}};","output":"str","x":430,"y":400,"wires":[["12fdb756.0d7579"]]},{"id":"12fdb756.0d7579","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":400,"wires":[["9d91d446.e01e78"]]},{"id":"9d91d446.e01e78","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":400,"wires":[["d37234f7.b541c8"]]},{"id":"683b9df7.b5bc94","type":"template","z":"57a86fb4.0e54e","name":"select distance","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from D_{{sensorId}};","output":"str","x":440,"y":460,"wires":[["88ed7f9c.694d9"]]},{"id":"88ed7f9c.694d9","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":460,"wires":[["705e5521.a12fac"]]},{"id":"705e5521.a12fac","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":460,"wires":[["3f84f210.ffb5ae"]]},{"id":"9e46e32.4dc172","type":"template","z":"57a86fb4.0e54e","name":"select motion","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from M_{{sensorId}};","output":"str","x":430,"y":520,"wires":[["c49f78eb.7a2d68"]]},{"id":"c49f78eb.7a2d68","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":520,"wires":[["f6887e77.ef93c"]]},{"id":"f6887e77.ef93c","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":520,"wires":[["be236b9e.ce3568"]]},{"id":"f839b66c.226058","type":"template","z":"57a86fb4.0e54e","name":"select light intensity","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from L_{{sensorId}};","output":"str","x":450,"y":580,"wires":[["f515f18b.ba525"]]},{"id":"f515f18b.ba525","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":580,"wires":[["bc7d1562.e62b38"]]},{"id":"bc7d1562.e62b38","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":580,"wires":[["51fdc743.2cb5d8"]]},{"id":"b1a3b6b.ab41548","type":"template","z":"57a86fb4.0e54e","name":"select e-field","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from E_{{sensorId}};","output":"str","x":430,"y":640,"wires":[["c75de7a8.49be18"]]},{"id":"c75de7a8.49be18","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":640,"wires":[["2cfed1c2.45d74e"]]},{"id":"2cfed1c2.45d74e","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":640,"wires":[["2ac6df8b.05427"]]},{"id":"57bef79b.6e2428","type":"template","z":"57a86fb4.0e54e","name":"select gyro","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from G_{{sensorId}};","output":"str","x":430,"y":700,"wires":[["5283f3a6.5da86c"]]},{"id":"5283f3a6.5da86c","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":700,"wires":[["1fd3b236.bd954e"]]},{"id":"1fd3b236.bd954e","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":700,"wires":[["7c7f340f.0ba36c"]]},{"id":"a564710d.c45c1","type":"template","z":"57a86fb4.0e54e","name":"select acceleration","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from A_{{sensorId}};","output":"str","x":450,"y":1120,"wires":[["5266b995.53d7f8"]]},{"id":"5266b995.53d7f8","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":1120,"wires":[["e50bd824.2dca78"]]},{"id":"e50bd824.2dca78","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":1120,"wires":[["ed0bd9b5.503a58"]]},{"id":"f3603d6.b1eb4c","type":"template","z":"57a86fb4.0e54e","name":"select UV","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from U_{{sensorId}};","output":"str","x":420,"y":760,"wires":[["244970c3.1da8a"]]},{"id":"244970c3.1da8a","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":760,"wires":[["832a4951.273598"]]},{"id":"832a4951.273598","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":760,"wires":[["6318c26b.deec8c"]]},{"id":"a6fd8c01.bc3a3","type":"template","z":"57a86fb4.0e54e","name":"select wind","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from W_{{sensorId}};","output":"str","x":430,"y":820,"wires":[["ddbd4c43.59f36"]]},{"id":"ddbd4c43.59f36","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":820,"wires":[["20fe62b8.5c405e"]]},{"id":"20fe62b8.5c405e","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":820,"wires":[["fe4581c2.46aa9"]]},{"id":"e54828ff.27f8a8","type":"template","z":"57a86fb4.0e54e","name":"select voltage","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from O_{{sensorId}};","output":"str","x":440,"y":880,"wires":[["fb59848b.c30fe8"]]},{"id":"fb59848b.c30fe8","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":880,"wires":[["ca6297a9.1c0738"]]},{"id":"ca6297a9.1c0738","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":880,"wires":[["4f0809a5.5b0128"]]},{"id":"be32d90c.9e54f8","type":"template","z":"57a86fb4.0e54e","name":"select humidity","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from H_{{sensorId}};","output":"str","x":440,"y":1000,"wires":[["a86f09c1.05c438"]]},{"id":"a86f09c1.05c438","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":1000,"wires":[["4a0ad2b9.64080c"]]},{"id":"4a0ad2b9.64080c","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":1000,"wires":[["7270d987.07a1c8"]]},{"id":"168d4a08.e912d6","type":"template","z":"57a86fb4.0e54e","name":"select VOC","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from V_{{sensorId}};","output":"str","x":430,"y":1060,"wires":[["754ff36.0ecc00c"]]},{"id":"754ff36.0ecc00c","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":1060,"wires":[["bad11556.567ff8"]]},{"id":"bad11556.567ff8","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":1060,"wires":[["45e5b8f1.f50728"]]},{"id":"1d81d222.7c3c9e","type":"link in","z":"57a86fb4.0e54e","name":"IN second phase csv","links":["52d79b33.42c6d4"],"x":35,"y":1100,"wires":[["9c553b46.42dba8"]]},{"id":"52d79b33.42c6d4","type":"link out","z":"57a86fb4.0e54e","name":"OUT first phase csv","links":["1d81d222.7c3c9e"],"x":1195,"y":600,"wires":[]},{"id":"ab0d8084.24f74","type":"link out","z":"57a86fb4.0e54e","name":"OUT second phase csv","links":["b8826614.5a2828"],"x":1195,"y":1100,"wires":[]},{"id":"3e4dd02d.7171b","type":"link out","z":"57a86fb4.0e54e","name":"OUT second phase direct","links":["150d58d7.ab0137"],"x":375,"y":1180,"wires":[]},{"id":"6098aee1.d79cd","type":"switch","z":"57a86fb4.0e54e","name":"switch sensorType","property":"sensorType","propertyType":"msg","rules":[{"t":"eq","v":"BME280","vt":"str"},{"t":"eq","v":"BMP280","vt":"str"},{"t":"eq","v":"CCS811","vt":"str"},{"t":"eq","v":"DHT22","vt":"str"},{"t":"eq","v":"MPU6050","vt":"str"},{"t":"eq","v":"BLUEDOT","vt":"str"}],"checkall":"true","repair":false,"outputs":6,"x":170,"y":1360,"wires":[["f3e9fbc6.9c8c38"],["f3e9fbc6.9c8c38"],["733626c9.0951a8"],["733626c9.0951a8"],["733626c9.0951a8"],["f3e9fbc6.9c8c38"]]},{"id":"b8826614.5a2828","type":"link in","z":"57a86fb4.0e54e","name":"IN third phase csv","links":["ab0d8084.24f74"],"x":35,"y":1360,"wires":[["6098aee1.d79cd"]]},{"id":"733626c9.0951a8","type":"link out","z":"57a86fb4.0e54e","name":"OUT third phase direct","links":["150d58d7.ab0137"],"x":375,"y":1380,"wires":[]},{"id":"f3e9fbc6.9c8c38","type":"template","z":"57a86fb4.0e54e","name":"select pressure","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from P_{{sensorId}};","output":"str","x":440,"y":1320,"wires":[["cdcfe701.0d3308"]]},{"id":"cdcfe701.0d3308","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":1320,"wires":[["48c9fcee.973414"]]},{"id":"48c9fcee.973414","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":1320,"wires":[["93d1944.9d1b768"]]},{"id":"7285ee7e.50c51","type":"link out","z":"57a86fb4.0e54e","name":"OUT third phase csv","links":["9893cc1e.76fc1"],"x":1195,"y":1320,"wires":[]},{"id":"9893cc1e.76fc1","type":"link in","z":"57a86fb4.0e54e","name":"IN fourth phase csv","links":["7285ee7e.50c51"],"x":35,"y":1520,"wires":[["bad48d2f.a3f3b"]]},{"id":"bad48d2f.a3f3b","type":"switch","z":"57a86fb4.0e54e","name":"switch sensorType","property":"sensorType","propertyType":"msg","rules":[{"t":"eq","v":"BME280","vt":"str"},{"t":"eq","v":"BMP280","vt":"str"},{"t":"eq","v":"BLUEDOT","vt":"str"}],"checkall":"true","repair":false,"outputs":3,"x":170,"y":1520,"wires":[["4f9d1b16.e40da4"],["669f51d6.4f5a2"],["4f304b92.2a0984"]]},{"id":"669f51d6.4f5a2","type":"template","z":"57a86fb4.0e54e","name":"select VOC","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from V_{{sensorId}};","output":"str","x":430,"y":1540,"wires":[["41905ef7.7338"]]},{"id":"41905ef7.7338","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":1540,"wires":[["4abae2dc.2141ec"]]},{"id":"4abae2dc.2141ec","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":1540,"wires":[["1c3a9e95.73d871"]]},{"id":"4f304b92.2a0984","type":"template","z":"57a86fb4.0e54e","name":"select light intensity","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select timehr,value from L_{{sensorId}};","output":"str","x":450,"y":1600,"wires":[["95f7f78e.e231e8"]]},{"id":"95f7f78e.e231e8","type":"sqlite","z":"57a86fb4.0e54e","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":670,"y":1600,"wires":[["3197b1d7.6f295e"]]},{"id":"3197b1d7.6f295e","type":"csv","z":"57a86fb4.0e54e","name":"to csv","sep":",","hdrin":false,"hdrout":true,"multi":"one","ret":"\\r\\n","temp":"timehr,value","skip":"0","x":850,"y":1600,"wires":[["72ebc063.cac8b"]]},{"id":"4f9d1b16.e40da4","type":"link out","z":"57a86fb4.0e54e","name":"OUT fourth phase","links":["150d58d7.ab0137"],"x":1195,"y":1500,"wires":[]},{"id":"8f0a134b.cacd5","type":"debug","z":"57a86fb4.0e54e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":530,"y":1980,"wires":[]},{"id":"150d58d7.ab0137","type":"link in","z":"57a86fb4.0e54e","name":"IN csv zip","links":["3e4dd02d.7171b","4f9d1b16.e40da4","733626c9.0951a8"],"x":295,"y":1800,"wires":[["8acee1f0.c6438"]]},{"id":"14cd8c48.2319f4","type":"comment","z":"57a86fb4.0e54e","name":"get all required measurement tables depending on selected sensor","info":"","x":260,"y":220,"wires":[]},{"id":"becbb1b7.c2753","type":"comment","z":"57a86fb4.0e54e","name":"zip the csv files","info":"","x":360,"y":1760,"wires":[]},{"id":"6e2e28e8.03bb78","type":"comment","z":"57a86fb4.0e54e","name":"activate download button on website","info":"","x":420,"y":1900,"wires":[]},{"id":"61eb373e.f61c28","type":"change","z":"57a86fb4.0e54e","name":"clean msg","rules":[{"t":"delete","p":"payload","pt":"msg"},{"t":"delete","p":"array","pt":"msg"},{"t":"set","p":"payload","pt":"msg","to":"true","tot":"bool"}],"action":"","property":"","from":"","to":"","reg":false,"x":350,"y":1940,"wires":[["269cd20c.36e38e","8f0a134b.cacd5"]]},{"id":"269cd20c.36e38e","type":"switch","z":"57a86fb4.0e54e","name":"set intended receiver modal","property":"modalType","propertyType":"msg","rules":[{"t":"eq","v":"connected","vt":"str"},{"t":"eq","v":"disconnected","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":600,"y":1940,"wires":[["577a0f05.1028f"],["731500bb.3b05"]]},{"id":"577a0f05.1028f","type":"change","z":"57a86fb4.0e54e","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"activateCsvDownloadCon","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":1920,"wires":[["fca82e24.56f88"]]},{"id":"731500bb.3b05","type":"change","z":"57a86fb4.0e54e","name":"","rules":[{"t":"set","p":"topic","pt":"msg","to":"activateCsvDownloadDiscon","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":850,"y":1960,"wires":[["fca82e24.56f88"]]},{"id":"fca82e24.56f88","type":"link out","z":"57a86fb4.0e54e","name":"OUT activate csv download button","links":["b41a4f94.069b"],"x":1015,"y":1940,"wires":[]},{"id":"86dddeee.8ebac","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/temperature.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":280,"wires":[["52d79b33.42c6d4"]]},{"id":"e4e94048.64378","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/button.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":340,"wires":[["52d79b33.42c6d4"]]},{"id":"d37234f7.b541c8","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/co2.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":400,"wires":[["52d79b33.42c6d4"]]},{"id":"3f84f210.ffb5ae","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/distance.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":460,"wires":[["52d79b33.42c6d4"]]},{"id":"be236b9e.ce3568","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/motion.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":520,"wires":[["52d79b33.42c6d4"]]},{"id":"51fdc743.2cb5d8","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/lightintensity.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":580,"wires":[["52d79b33.42c6d4"]]},{"id":"2ac6df8b.05427","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/efield.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":640,"wires":[["52d79b33.42c6d4"]]},{"id":"7c7f340f.0ba36c","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/gyro.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":700,"wires":[["52d79b33.42c6d4"]]},{"id":"6318c26b.deec8c","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/uv.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":760,"wires":[["52d79b33.42c6d4"]]},{"id":"fe4581c2.46aa9","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/wind.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":820,"wires":[["52d79b33.42c6d4"]]},{"id":"4f0809a5.5b0128","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/voltage.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":880,"wires":[["52d79b33.42c6d4"]]},{"id":"7270d987.07a1c8","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/humidity.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":1000,"wires":[["ab0d8084.24f74"]]},{"id":"45e5b8f1.f50728","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/voc.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":1060,"wires":[["ab0d8084.24f74"]]},{"id":"ed0bd9b5.503a58","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/acceleration.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":1120,"wires":[["ab0d8084.24f74"]]},{"id":"93d1944.9d1b768","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/pressure.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":1320,"wires":[["7285ee7e.50c51"]]},{"id":"1c3a9e95.73d871","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/voc.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":1540,"wires":[["4f9d1b16.e40da4"]]},{"id":"72ebc063.cac8b","type":"file","z":"57a86fb4.0e54e","name":"write to file","filename":"/home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/lightintensity.csv","appendNewline":false,"createDir":true,"overwriteFile":"true","encoding":"none","x":1010,"y":1600,"wires":[["4f9d1b16.e40da4"]]},{"id":"355dead8.053166","type":"exec","z":"57a86fb4.0e54e","command":"zip -r -j /home/pi/.node-red/uibuilder/devicesettings/src/data.zip /home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/*","addpay":false,"append":"","useSpawn":"false","timer":"10","oldrc":false,"name":"zip to data.zip","x":660,"y":1800,"wires":[["61eb373e.f61c28"],[],[]]},{"id":"8acee1f0.c6438","type":"exec","z":"57a86fb4.0e54e","command":"rm /home/pi/.node-red/uibuilder/devicesettings/src/data.zip","addpay":false,"append":"","useSpawn":"false","timer":"10","oldrc":false,"name":"remove old data.zip","x":450,"y":1800,"wires":[["355dead8.053166"],[],[]]},{"id":"a3fdd85c.194d68","type":"exec","z":"57a86fb4.0e54e","command":"rm /home/pi/.node-red/uibuilder/devicesettings/src/csvTemp/*","addpay":false,"append":"","useSpawn":"false","timer":"10","oldrc":false,"name":"remove old .csv","x":160,"y":420,"wires":[["dd135ae4.85b9a8"],[],[]]},{"id":"6a1e3a82.baf1f4","type":"template","z":"9648297c.564688","name":"select * from uilayout","field":"topic","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"select * from uilayout;","output":"str","x":640,"y":1700,"wires":[["f3d71339.05465"]]},{"id":"f3d71339.05465","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":870,"y":1700,"wires":[["2a9a71.3237559","644af081.fee34"]]},{"id":"1ce2590b.399677","type":"comment","z":"9648297c.564688","name":"save new item positions","info":"","x":480,"y":1660,"wires":[]},{"id":"24d1ef98.a4d28","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":830,"y":1760,"wires":[]},{"id":"2a9a71.3237559","type":"debug","z":"9648297c.564688","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1050,"y":1700,"wires":[]},{"id":"644af081.fee34","type":"function","z":"9648297c.564688","name":"change group- and itemnumbers","func":"var movedGroupId = Number(msg.movedItemId.split('-')[2]);\nvar movedItemId =  Number(msg.movedItemId.split('-')[4]);\nvar prevGroupId =  Number(msg.prevCardId.split('-')[2]);\nvar prevItemId =  Number(msg.prevCardId.split('-')[4]);\nvar nextGroupId =  Number(msg.nextCardId.split('-')[2]);\nvar nextItemId =  Number(msg.nextCardId.split('-')[4]);\n\n//defaults:\nmsg.prevNumberGroup = prevGroupId;\nmsg.prevNumberItem = prevItemId;\nmsg.nextNumberGroup = nextGroupId;\nmsg.nextNumberItem = nextItemId;\nmsg.movedNumberGroup = movedGroupId;\nmsg.movedNumberItem = movedItemId;\n\nmsg.test2=0\n//j entspricht verschobene payload nummer\nj=0;\nwhile(!(msg.payload[j].numbergroup===movedGroupId && msg.payload[j].numberitem===movedItemId)){\n    j++;\n}\n\n\nif(movedGroupId===prevGroupId){\n    //in der selben Gruppe nach hinten gezogen\n    if (movedItemId>prevItemId){\n        for(i=0;i<msg.payload.length;i++){\n            if (msg.payload[i].numbergroup===movedGroupId && msg.payload[i].numberitem<movedItemId && msg.payload[i].numberitem>prevItemId){\n                msg.payload[i].numberitem++\n                msg.test2++\n            }\n        }\n        msg.payload[j].numberitem=prevItemId+1\n    }\n    \n    //in der selben Gruppe nach vorne gezogen\n    else if (movedItemId<prevItemId){\n        for(i=0;i<msg.payload.length;i++){\n            if (msg.payload[i].numbergroup===movedGroupId && msg.payload[i].numberitem>movedItemId && msg.payload[i].numberitem<=prevItemId){\n                msg.payload[i].numberitem--\n            }\n        }\n        msg.payload[j].numberitem=prevItemId\n    }\n}\n//in eine andere Gruppe\nelse{\n    //Gruppe zu der ein Element hinzugefgt wird\n    for(i=0;i<msg.payload.length;i++){\n            if (msg.payload[i].numbergroup===prevGroupId && msg.payload[i].numberitem>=(prevItemId+1)){\n                msg.payload[i].numberitem++\n            }\n        }\n        msg.payload[j].numberitem=prevItemId+1\n        msg.payload[j].numbergroup=prevGroupId\n        \n    //Gruppe aus der ein Element entfernt wurde\n    for(i=0;i<msg.payload.length;i++){\n        if(msg.payload[i].numbergroup===movedGroupId){\n            if (msg.payload[i].numbergroup===movedGroupId && msg.payload[i].numberitem>movedItemId){\n                msg.payload[i].numberitem--\n            }\n        }\n    }\n}\n\n//uigroups\nmsg.test3=0\nmsg.test4=0\nmsg.test5=0\nmsg.group=[movedGroupId,prevGroupId]\nmsg.from=\"\"\nmsg.to=\"\"\nfor(i=1;i<=msg.payload.length;i++){\n    for(k=0;k<msg.payload.length;k++){\n        if(msg.payload[k].numbergroup===movedGroupId && msg.payload[k].numberitem===i){\n            if(msg.payload[k].htmlid.search(\"chart\")!=-1){\n                msg.from=msg.from+\"C\"\n                msg.test4++\n            }\n            else if(msg.payload[k].htmlid.search(\"val\")!=-1){\n                msg.from=msg.from+\"V\"\n                msg.test4++\n            }\n        }\n    }\n    \n    \n    for(k=0;k<msg.payload.length;k++){\n        if(msg.payload[k].numbergroup===prevGroupId && msg.payload[k].numberitem===i){\n            msg.test5++;\n            if(msg.payload[k].htmlid.search(\"chart\")!=-1){\n                msg.to=msg.to+\"C\";\n                msg.test3++;\n            }\n            else if(msg.payload[k].htmlid.search(\"val\")!=-1){\n                msg.to=msg.to+\"V\";\n                msg.test3++;\n            }\n        }\n    }\n}\n\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":1760,"wires":[["24d1ef98.a4d28","51f5689d.1ea2d8","630013f4.39f21c"]]},{"id":"fe84d735.ca9af8","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":1070,"y":1880,"wires":[["f8bc4354.a0aed"]]},{"id":"630013f4.39f21c","type":"function","z":"9648297c.564688","name":"update uilayout","func":"for (i=0;i<msg.payload.length;i++){\n    var isComplete = false;\n    if (i == (msg.payload.length - 1)) {\n        //is last element\n        isComplete = true;\n    }\n    \n    tempTopic=\"update uilayout set numbergroup= \"+msg.payload[i].numbergroup.toString()+\", numberitem= \"+msg.payload[i].numberitem.toString()+\" where id = \"+msg.payload[i].id.toString();\n    if (isComplete) {\n        node.send({\n            \"topic\": tempTopic,\n            \"index\": i,\n            \"parts\": { \"index\": i },\n            \"complete\": isComplete\n        });\n    }\n    else {\n        node.send({\n            \"topic\": tempTopic,\n            \"index\": i,\n            \"parts\": { \"index\": i }\n        });\n    }\n}\n//return msg;","outputs":1,"noerr":0,"x":660,"y":1880,"wires":[["4fcbf9a5.4f1b78"]]},{"id":"4fcbf9a5.4f1b78","type":"delay","z":"9648297c.564688","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":860,"y":1880,"wires":[["fe84d735.ca9af8"]]},{"id":"d42c41f1.fb4f6","type":"change","z":"9648297c.564688","name":"delete msg properties","rules":[{"t":"delete","p":"topic","pt":"msg"},{"t":"delete","p":"payload","pt":"msg"},{"t":"set","p":"uibuilderCtrl","pt":"msg","to":"ready for content","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":640,"y":1940,"wires":[["54ffb11c.1a971","60f6ec0.2339314"]]},{"id":"d64572d.f9e119","type":"link out","z":"9648297c.564688","name":"OUT delete dashboard group","links":["8522f4ba.537b88"],"x":975,"y":1940,"wires":[]},{"id":"54ffb11c.1a971","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":830,"y":1980,"wires":[]},{"id":"60f6ec0.2339314","type":"delay","z":"9648297c.564688","name":"1 msg / 1s","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":850,"y":1940,"wires":[["d64572d.f9e119"]]},{"id":"f8bc4354.a0aed","type":"join","z":"9648297c.564688","name":"","mode":"custom","build":"object","property":"payload","propertyType":"msg","key":"index","joiner":"\\n","joinerType":"str","accumulate":false,"timeout":"","count":"","reduceRight":false,"reduceExp":"","reduceInit":"","reduceInitType":"num","reduceFixup":"","x":1250,"y":1880,"wires":[["d42c41f1.fb4f6"]]},{"id":"e7716833.9d0408","type":"sqlite","z":"9648297c.564688","mydb":"667529e2.c47648","sqlquery":"msg.topic","sql":"","name":"","x":1070,"y":1820,"wires":[[]]},{"id":"51f5689d.1ea2d8","type":"function","z":"9648297c.564688","name":"update uigroups","func":"for (i=0;i<msg.group.length;i++){\n    var isComplete = false;\n    if (i == (msg.group.length - 1)) {\n        //is last element\n        isComplete = true;\n    }\n    \n    tempTopic1=\"update uigroups set items= '\"+msg.from+\"' where htmlid = \"+msg.group[0]+\";\";\n    tempTopic2=\"update uigroups set items= '\"+msg.to+\"' where htmlid = \"+msg.group[1]+\";\";\n    if (isComplete) {\n        node.send({\n            \"topic\": tempTopic1,\n            \"index\": i,\n            \"parts\": { \"index\": i },\n            \"complete\": isComplete\n        });\n    }\n    else {\n        node.send({\n            \"topic\": tempTopic2,\n            \"index\": i,\n            \"parts\": { \"index\": i }\n        });\n    }\n}\n//return msg;","outputs":1,"noerr":0,"x":660,"y":1820,"wires":[["bad0fe18.ee7ac"]]},{"id":"bad0fe18.ee7ac","type":"delay","z":"9648297c.564688","name":"1 msg / 20ms","pauseType":"rate","timeout":"50","timeoutUnits":"milliseconds","rate":"1","nbRateUnits":"0.02","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":860,"y":1820,"wires":[["e7716833.9d0408","3bb2e6a8.ad7dea"]]},{"id":"3bb2e6a8.ad7dea","type":"debug","z":"9648297c.564688","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1030,"y":1780,"wires":[]}]